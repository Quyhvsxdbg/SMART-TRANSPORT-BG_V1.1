<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e3c72',
                        'primary-light': '#2a5298',
                        'secondary': '#4a90e2',
                        'secondary-light': '#357abd',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #4a90e2, #357abd);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #ffffff, #f8fbff);
        }

        .gradient-light {
            background: linear-gradient(135deg, #f8fbff, #e8f4fd);
        }

        .gradient-table {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
        }

        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f3f3f3;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
        }

        .route-row {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .route-row:hover {
            background-color: #f0f9ff;
            transform: translateY(-1px);
        }

        .filter-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .filter-panel.open {
            max-height: 600px;
        }

        .distance-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out;
        }

        .distance-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Export menu styling */
        #exportMenu {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
        }

        #exportMenu button:hover {
            background-color: #f3f4f6;
            transform: none;
            box-shadow: none;
        }

        #exportMenu button {
            transition: background-color 0.2s ease;
            border-radius: 0;
        }

        #exportMenu button:first-child {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        #exportMenu button:last-child {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        /* Loading overlay */
        .fixed.inset-0.bg-black {
            backdrop-filter: blur(2px);
        }

        /* Success/Error messages */
        .fixed.top-4.right-4 {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="font-sans min-h-screen leading-relaxed bg-gray-50">
    <div id="loadingMessage" class="text-center py-20">
        <div class="loading mb-4"></div>
        <p class="mb-4">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        <div class="progress-bar mx-auto max-w-md mb-2">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div id="loadingText" class="text-sm text-gray-600">Kh·ªüi t·∫°o...</div>
    </div>

    <!-- Danh s√°ch tuy·∫øn -->
    <div id="routeListContent"
        class="max-w-8xl mx-auto bg-white rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-100"
        style="display: none;">
        <!-- Header ch√≠nh th·ª©c -->
        <div class="text-white pt-6 pb-3 px-8 text-center relative flex items-center justify-center"
            style="background: url(https://hoangmv.github.io/SMART-TRANSPORT-BG_V1.1/bg_header-qlvt.png) center center / cover no-repeat;">
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-center gap-5 mb-4">
                    <div
                        class="w-15 h-15 bg-white rounded-full flex items-center justify-center text-3xl text-primary font-bold shadow-lg">
                        üöå
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-shadow-lg">TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I</h1>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation header v·ªõi tabs -->
        <div class="bg-blue-600 text-white">
            <div class="flex">
                <div class="bg-blue-500 px-6 py-3 font-semibold border-r border-blue-400 flex items-center gap-2">
                    üìã TUY·∫æN C√îNG B·ªê
                </div>
            </div>
        </div>

        <!-- Search bar -->
        <div class="bg-gray-100 p-2 border-b px-8">
            <div class="flex items-center gap-4 flex-wrap">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo t√™n/m√£ tuy·∫øn..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="performSearch()"
                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    üîç T√¨m ki·∫øm
                </button>
                <button onclick="toggleAdvancedSearch()"
                    class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    üîß B·ªô l·ªçc n√¢ng cao
                </button>
                <div class="relative">
                    <button onclick="toggleExportMenu()"
                        class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-colors flex items-center gap-2">
                        üìä Xu·∫•t Excel
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="exportMenu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                        <div class="py-2">
                            <button onclick="exportToExcel('all')" 
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                                üìã Danh s√°ch t·ªïng th·ªÉ
                            </button>
                            <button onclick="exportToExcel('active')" 
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                                ‚úÖ Tuy·∫øn ƒëang khai th√°c
                            </button>
                            <button onclick="exportToExcel('inactive')" 
                                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                                ‚ùå Tuy·∫øn ch∆∞a khai th√°c
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced search panel -->
        <div id="advancedSearchPanel" class="filter-panel bg-blue-50 border-b px-8">
            <div class="p-3">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-800">üîç B·ªô l·ªçc t√¨m ki·∫øm n√¢ng cao</h3>
                    <button onclick="clearAdvancedFilter()"
                        class="text-sm text-gray-500 hover:text-red-500 transition-colors">
                        üóëÔ∏è X√≥a t·∫•t c·∫£
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-8 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T·ªânh ƒëi</label>
                        <select id="filterTinhDi"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">B·∫øn ƒëi</label>
                        <select id="filterBenDi"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T·ªânh ƒë·∫øn</label>
                        <select id="filterTinhDen"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">B·∫øn ƒë·∫øn</label>
                        <select id="filterBenDen"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ph√¢n lo·∫°i tuy·∫øn</label>
                        <select id="filterPhanLoai"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">C·ª± ly tuy·∫øn (km)</label>
                        <input type="text" id="filterCuLy" placeholder="10-50, >10, <50"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√™n ƒë∆°n v·ªã khai th√°c</label>
                        <select id="filterDonViKhaiThac"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√¨nh tr·∫°ng tuy·∫øn</label>
                        <select id="filterTinhTrangTuyen"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="ƒêang khai th√°c">ƒêang khai th√°c</option>
                            <option value="Ch∆∞a khai th√°c">Ch∆∞a khai th√°c</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results count -->
        <div class="bg-gray-50 px-6 py-2 border-b px-8">
            <span class="text-sm text-gray-600">
                Hi·ªÉn th·ªã <span id="routeCount" class="font-semibold text-blue-600">0</span> tuy·∫øn
            </span>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto px-8">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-200 text-gray-700">
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[50px]">STT</th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[100px]">M√£ tuy·∫øn
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[120px]">
                            T·ªânh n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[120px]">
                            T·ªânh n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[120px]">
                            BX n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[120px]">
                            BX n∆°i ƒëi/<br>ƒë·∫øn (v√†<br>ng∆∞·ª£c l·∫°i)
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[430px]">H√†nh
                            tr√¨nh ch·∫°y xe</th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[60px]">
                            C·ª±<br>ly<br>tuy·∫øn<br>(km)
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[70px]">
                            L∆∞u<br>l∆∞·ª£ng<br>cho<br>ph√©p<br>(chuy·∫øn/<br>th√°ng)
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[60px]">
                            T·ªïng<br>s·ªë<br>chuy·∫øn<br>ƒëang<br>khai<br>th√°c
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[60px]">
                            L∆∞u<br>l∆∞·ª£ng<br>c√≤n<br>l·∫°i
                        </th>
                        <th class="px-2 py-2 text-center font-semibold border-r border-gray-300 min-w-[60px]">
                            Th·ªùi<br>gian<br>gi√£n<br>c√°ch<br>t·ªëi<br>thi·ªÅu<br>(ph√∫t/<br>chuy·∫øn)
                        </th>
                        <th class="px-2 py-2 text-center font-semibold min-w-[60px]">Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody id="routeTableBody">
                    <!-- D·ªØ li·ªáu tuy·∫øn s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
                </tbody>
            </table>
        </div>

        <!-- Footer th√¥ng tin -->
        <div class="gradient-primary text-white py-5 text-center">
            <p class="mt-1 mb-0 text-xs opacity-70">
                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="current-time-list"></span>
            </p>
        </div>
    </div>

    <!-- Chi ti·∫øt tuy·∫øn -->
    <div id="routeDetailContent"
        class="max-w-8xl mx-auto bg-white rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-100"
        style="display: none;">
        <!-- Header ch√≠nh th·ª©c -->
        <div class="text-white pt-6 pb-3 px-8 text-center relative flex items-center justify-center"
            style="background: url(https://hoangmv.github.io/SMART-TRANSPORT-BG_V1.1/bg_header-qlvt.png) center center / cover no-repeat;">
            <div class="absolute inset-0 bg-black bg-opacity-30"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-center gap-5 mb-4">
                    <div
                        class="w-15 h-15 bg-white rounded-full flex items-center justify-center text-3xl text-primary font-bold shadow-lg">
                        üöå
                    </div>
                    <div>
                        <h1 class="text-4xl font-bold text-shadow-lg">TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I</h1>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation header -->
        <div
            class="gradient-secondary text-white py-2 px-6 flex justify-between items-center border-b-4 border-blue-700">
            <h2 class="text-lg font-semibold flex items-center gap-3">
                <span class="text-xl">üìä</span>
                TH√îNG TIN TUY·∫æN
            </h2>
            <button onclick="backToList()"
                class="bg-white text-secondary px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-colors flex items-center gap-2">
                ‚Üê Quay l·∫°i danh s√°ch
            </button>
        </div>

        <!-- Th√¥ng tin chi ti·∫øt tuy·∫øn -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">Th√¥ng tin chi ti·∫øt tuy·∫øn</span>
            </div>

            <div class="gradient-bg px-20 py-4" id="tuyenInfo">
                <!-- Th√¥ng tin tuy·∫øn s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
            </div>
        </div>

        <!-- Th√¥ng tin th√¥ng b√°o ƒë∆°n v·ªã ƒëƒÉng k√Ω khai th√°c th√†nh c√¥ng -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">Th√¥ng tin th√¥ng b√°o ƒë∆°n v·ªã ƒëƒÉng
                    k√Ω khai th√°c th√†nh c√¥ng</span>
            </div>

            <div class="gradient-bg p-4">
                <table class="w-full border-collapse border-2 border-gray-200 rounded-lg overflow-hidden shadow-lg">
                    <thead>
                        <tr>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                STT</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                S·ªë th√¥ng b√°o</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Ng√†y vƒÉn b·∫£n th√¥ng b√°o</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Ng√†y b·∫Øt ƒë·∫ßu khai th√°c</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                C∆° quan c·∫•p</th>
                            <th
                                class="gradient-primary text-white py-4 px-3 text-center text-xs font-bold uppercase tracking-wider">
                                Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="thongBaoTable">
                        <!-- D·ªØ li·ªáu th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì xe ch·∫°y -->
        <div class="border-b-4 border-gray-100">
            <div class="gradient-light py-3 px-6 border-b-2 border-blue-200 flex items-center gap-4">
                <div class="text-secondary bg-white rounded-full shadow-md">üìã</div>
                <span class="font-bold text-gray-700 text-base uppercase tracking-wide">
                    Bi·ªÉu ƒë·ªì xe ch·∫°y
                    <span class="text-red-600 font-semibold">( Ch·ªâ c·∫≠p nh·∫≠t c√°c gi·ªù ƒëang c√≥ ƒë∆°n v·ªã KDVT khai th√°c
                        )</span>
                </span>
            </div>

            <!-- Legend -->
            <div class="flex gap-8 p-3 gradient-light text-xs justify-end flex-wrap border-b-2 border-gray-200">
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-gray-100 border-gray-200 shadow-sm"></div>
                    <span>Ch∆∞a ƒëƒÉng k√Ω</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-lime-300 border-white shadow-sm"></div>
                    <span>ƒêang khai th√°c</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-amber-300 border-white shadow-sm"></div>
                    <span>C√≤n l∆∞u l∆∞·ª£ng</span>
                </div>
                <div class="flex items-center gap-2 py-2 px-4 bg-white rounded-full shadow-md border-2 border-gray-100">
                    <div class="w-8 h-4 bg-amber-100 border-white shadow-sm"></div>
                    <span>H·∫øt l∆∞u l∆∞·ª£ng</span>
                </div>
            </div>

            <!-- L·ªãch xe ch·∫°y -->
            <div class="gradient-primary text-white text-center py-5 font-bold text-base uppercase tracking-wider">
                Gi·ªù xu·∫•t b·∫øn
            </div>

            <div id="bieuDoXeChay">
                <!-- Bi·ªÉu ƒë·ªì xe ch·∫°y s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
            </div>
        </div>

        <!-- Footer th√¥ng tin -->
        <div class="gradient-primary text-white py-5 text-center">
            <p class="mt-1 mb-0 text-xs opacity-70">
                C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="current-time"></span>
            </p>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = 'd22767b5-f711-42f8-bbbd-4cf04b26ef3d';
        const accessKey = 'V2-Qcjpo-7Ybu9-g87XI-TFLes-kJGWn-btYR5-cLMmk-FjrRj';
        const region = 'www';

        // Global data storage
        let allTuyenData = [];
        let allThongBaoData = [];
        let allChiTietData = [];
        let filteredTuyenData = [];

        // Progress tracking
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('loadingText').textContent = text;
        }

        // Function to fetch data from AppSheet
        async function fetchDataFromAppSheet(tableName) {
            try {
                const body = {
                    Action: 'Find',
                    Properties: {},
                    Selector: `Filter(${tableName}, true)`
                };

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error(`Failed to fetch data from ${tableName}:`, error);
                return [];
            }
        }

        // Load all data in parallel
        async function loadAllDataParallel() {
            updateProgress(10, 'ƒêang t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu...');

            const [tuyenData, thongBaoData, chiTietData] = await Promise.all([
                fetchDataFromAppSheet('DANHMUCTUYENCODINH'),
                fetchDataFromAppSheet('THONGBAO_KHAITHAC'),
                fetchDataFromAppSheet('BieuDoChayXeChiTiet')
            ]);

            updateProgress(60, 'ƒê√£ t·∫£i xong d·ªØ li·ªáu, ƒëang x·ª≠ l√Ω...');

            return {
                tuyenData,
                thongBaoData,
                chiTietData
            };
        }

        // Format date function
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Calculate active notifications for a route
        function getActiveNotificationsCount(maSoTuyen) {
            return allThongBaoData.filter(tb =>
                tb.Ref_Tuyen === maSoTuyen &&
                (!tb.TrangThai || tb.TrangThai !== 'H·∫øt hi·ªáu l·ª±c')
           ).length;
       }

       // Calculate remaining capacity
       function getRemainingCapacity(tuyen) {
           const tongChuyen = parseInt(tuyen.TongChuyenThang) || 0;
           const chuyenDaKhaiThac = parseInt(tuyen.ChuyenDaKhaiThac) || 0;
           return Math.max(0, tongChuyen - chuyenDaKhaiThac);
       }

       // Get route status
       function getRouteStatus(tuyen) {
           const activeNotifications = getActiveNotificationsCount(tuyen.MaSoTuyen);
           return activeNotifications > 0 ? 'ƒêang khai th√°c' : 'Ch∆∞a khai th√°c';
       }

       // Toggle export menu
       function toggleExportMenu() {
           const menu = document.getElementById('exportMenu');
           menu.classList.toggle('hidden');
       }

       // Close export menu when clicking outside
       document.addEventListener('click', function(event) {
           const menu = document.getElementById('exportMenu');
           const button = event.target.closest('button[onclick="toggleExportMenu()"]');
           
           if (!button && !menu.contains(event.target)) {
               menu.classList.add('hidden');
           }
       });

       // Export to Excel function
       async function exportToExcel(type) {
           try {
               // Close export menu
               document.getElementById('exportMenu').classList.add('hidden');
               
               // Show loading
               const loadingDiv = document.createElement('div');
               loadingDiv.innerHTML = `
                   <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                       <div class="bg-white rounded-lg p-6 flex items-center gap-4">
                           <div class="loading"></div>
                           <span>ƒêang xu·∫•t Excel...</span>
                       </div>
                   </div>
               `;
               document.body.appendChild(loadingDiv);

               // Filter data based on type
               let dataToExport = [];
               let fileName = '';
               let sheetName = '';

               switch(type) {
                   case 'all':
                       dataToExport = allTuyenData;
                       fileName = 'Danh_sach_tuyen_tong_the';
                       sheetName = 'Danh s√°ch t·ªïng th·ªÉ';
                       break;
                   case 'active':
                       dataToExport = allTuyenData.filter(tuyen => {
                           const chuyenDaKhaiThac = parseInt(tuyen.ChuyenDaKhaiThac) || 0;
                           return chuyenDaKhaiThac > 0;
                       });
                       fileName = 'Danh_sach_tuyen_dang_khai_thac';
                       sheetName = 'Tuy·∫øn ƒëang khai th√°c';
                       break;
                   case 'inactive':
                       dataToExport = allTuyenData.filter(tuyen => {
                           const chuyenDaKhaiThac = parseInt(tuyen.ChuyenDaKhaiThac) || 0;
                           return chuyenDaKhaiThac === 0;
                       });
                       fileName = 'Danh_sach_tuyen_chua_khai_thac';
                       sheetName = 'Tuy·∫øn ch∆∞a khai th√°c';
                       break;
               }

               // Create workbook
               const workbook = new ExcelJS.Workbook();
               const worksheet = workbook.addWorksheet(sheetName);

               // Add title
               worksheet.mergeCells('A1:M1');
               const titleCell = worksheet.getCell('A1');
               titleCell.value = 'TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I - ' + sheetName.toUpperCase();
               titleCell.font = { bold: true, size: 16, color: { argb: 'FFFFFF' } };
               titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '1e3c72' } };
               titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
               worksheet.getRow(1).height = 30;

               // Add export info
               worksheet.mergeCells('A2:M2');
               const infoCell = worksheet.getCell('A2');
               infoCell.value = `Xu·∫•t ng√†y: ${new Date().toLocaleString('vi-VN')} | T·ªïng s·ªë tuy·∫øn: ${dataToExport.length}`;
               infoCell.font = { italic: true, size: 10 };
               infoCell.alignment = { horizontal: 'center' };

               // Add headers
               const headers = [
                   'STT',
                   'M√£ tuy·∫øn',
                   'T·ªânh ƒëi',
                   'T·ªânh ƒë·∫øn', 
                   'BX ƒëi',
                   'BX ƒë·∫øn',
                   'H√†nh tr√¨nh ch·∫°y xe',
                   'C·ª± ly tuy·∫øn (km)',
                   'L∆∞u l∆∞·ª£ng cho ph√©p (chuy·∫øn/th√°ng)',
                   'T·ªïng s·ªë chuy·∫øn ƒëang khai th√°c',
                   'L∆∞u l∆∞·ª£ng c√≤n l·∫°i',
                   'Th·ªùi gian gi√£n c√°ch t·ªëi thi·ªÉu (ph√∫t/chuy·∫øn)',
                   'T√¨nh tr·∫°ng'
               ];

               const headerRow = worksheet.addRow(headers);
               headerRow.eachCell((cell, colNumber) => {
                   cell.font = { bold: true, color: { argb: 'FFFFFF' } };
                   cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '4a90e2' } };
                   cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                   cell.border = {
                       top: { style: 'thin' },
                       left: { style: 'thin' },
                       bottom: { style: 'thin' },
                       right: { style: 'thin' }
                   };
               });
               worksheet.getRow(3).height = 40;

               // Add data
               dataToExport.forEach((tuyen, index) => {
                   const remainingCapacity = getRemainingCapacity(tuyen);
                   const status = getRouteStatus(tuyen);
                   
                   const row = worksheet.addRow([
                       index + 1,
                       tuyen.MaSoTuyen || '',
                       tuyen.TinhDi || '',
                       tuyen.TinhDen || '',
                       tuyen.BenDi || '',
                       tuyen.BenDen || '',
                       tuyen.HanhTrinh || '',
                       tuyen.CuLyTuyen_km || '',
                       tuyen.TongChuyenThang || '',
                       tuyen.ChuyenDaKhaiThac || '0',
                       remainingCapacity,
                       tuyen.GianCachToiThieu_phut || '',
                       status
                   ]);

                   // Style data rows
                   row.eachCell((cell, colNumber) => {
                       cell.border = {
                           top: { style: 'thin' },
                           left: { style: 'thin' },
                           bottom: { style: 'thin' },
                           right: { style: 'thin' }
                       };
                       
                       // Center align certain columns
                       if ([1, 8, 9, 10, 11, 12, 13].includes(colNumber)) {
                           cell.alignment = { horizontal: 'center', vertical: 'middle' };
                       } else {
                           cell.alignment = { vertical: 'middle', wrapText: true };
                       }

                       // Color code status
                       if (colNumber === 13) { // Status column
                           if (status === 'ƒêang khai th√°c') {
                               cell.font = { color: { argb: '059669' }, bold: true };
                           } else {
                               cell.font = { color: { argb: 'dc2626' }, bold: true };
                           }
                       }

                       // Color code remaining capacity
                       if (colNumber === 11) { // Remaining capacity column
                           if (remainingCapacity > 0) {
                               cell.font = { color: { argb: '059669' } };
                           } else {
                               cell.font = { color: { argb: 'dc2626' } };
                           }
                       }
                   });

                   // Alternate row colors
                   if (index % 2 === 0) {
                       row.eachCell(cell => {
                           if (!cell.fill || !cell.fill.fgColor) {
                               cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'f9fafb' } };
                           }
                       });
                   }
               });

               // Auto-fit columns
               worksheet.columns = [
                   { width: 6 },   // STT
                   { width: 12 },  // M√£ tuy·∫øn
                   { width: 15 },  // T·ªânh ƒëi
                   { width: 15 },  // T·ªânh ƒë·∫øn
                   { width: 20 },  // BX ƒëi
                   { width: 20 },  // BX ƒë·∫øn
                   { width: 50 },  // H√†nh tr√¨nh
                   { width: 12 },  // C·ª± ly
                   { width: 15 },  // L∆∞u l∆∞·ª£ng cho ph√©p
                   { width: 15 },  // Chuy·∫øn ƒëang khai th√°c
                   { width: 12 },  // L∆∞u l∆∞·ª£ng c√≤n l·∫°i
                   { width: 15 },  // Th·ªùi gian gi√£n c√°ch
                   { width: 15 }   // T√¨nh tr·∫°ng
               ];

               // Add footer
               const footerRowIndex = worksheet.rowCount + 2;
               worksheet.mergeCells(`A${footerRowIndex}:M${footerRowIndex}`);
               const footerCell = worksheet.getCell(`A${footerRowIndex}`);
               footerCell.value = `B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng TH√îNG TIN TUY·∫æN V·∫¨N T·∫¢I - ${new Date().toLocaleString('vi-VN')}`;
               footerCell.font = { italic: true, size: 9, color: { argb: '666666' } };
               footerCell.alignment = { horizontal: 'center' };

               // Generate Excel file
               const buffer = await workbook.xlsx.writeBuffer();
               
               // Download file
               const blob = new Blob([buffer], { 
                   type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
               });
               
               const url = window.URL.createObjectURL(blob);
               const link = document.createElement('a');
               link.href = url;
               link.download = `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`;
               link.click();
               
               window.URL.revokeObjectURL(url);

               // Remove loading
               document.body.removeChild(loadingDiv);

               // Show success message
               const successDiv = document.createElement('div');
               successDiv.innerHTML = `
                   <div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2">
                       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                       </svg>
                       Xu·∫•t Excel th√†nh c√¥ng!
                   </div>
               `;
               document.body.appendChild(successDiv);
               
               setTimeout(() => {
                   document.body.removeChild(successDiv);
               }, 3000);

           } catch (error) {
               console.error('Export error:', error);
               
               // Remove loading if exists
               const loadingDiv = document.querySelector('.fixed.inset-0.bg-black');
               if (loadingDiv && loadingDiv.parentElement) {
                   document.body.removeChild(loadingDiv.parentElement);
               }

               // Show error message
               const errorDiv = document.createElement('div');
               errorDiv.innerHTML = `
                   <div class="fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2">
                       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                       </svg>
                       L·ªói xu·∫•t Excel: ${error.message}
                   </div>
               `;
               document.body.appendChild(errorDiv);
               
               setTimeout(() => {
                   document.body.removeChild(errorDiv);
               }, 5000);
           }
       }

       // Display route list as table
       function displayRouteList(tuyenList) {
           const tableBody = document.getElementById('routeTableBody');
           const routeCount = document.getElementById('routeCount');

           routeCount.textContent = tuyenList.length;

           if (!tuyenList || tuyenList.length === 0) {
               tableBody.innerHTML = `
                   <tr>
                       <td colspan="13" class="text-center py-8 text-gray-500 italic">
                           Kh√¥ng t√¨m th·∫•y tuy·∫øn n√†o ph√π h·ª£p v·ªõi ti√™u ch√≠ t√¨m ki·∫øm
                       </td>
                   </tr>
               `;
               return;
           }

           let html = '';
           tuyenList.forEach((tuyen, index) => {
               const activeNotifications = getActiveNotificationsCount(tuyen.MaSoTuyen);
               const remainingCapacity = getRemainingCapacity(tuyen);

               html += `
                  <tr class="route-row border-b border-gray-200 hover:bg-blue-50" onclick="showRouteDetail('${tuyen.MaSoTuyen}')">
                      <td class="px-2 py-2 text-center border-r border-gray-200">${index + 1}</td>
                      <td class="px-2 py-2 text-center border-r border-gray-200 font-medium text-blue-600">${tuyen.MaSoTuyen || ''}</td>
                      <td class="px-2 py-2 border-r border-gray-200">${tuyen.TinhDi || ''}</td>
                      <td class="px-2 py-2 border-r border-gray-200">${tuyen.TinhDen || ''}</td>
                      <td class="px-2 py-2 border-r border-gray-200">${tuyen.BenDi || ''}</td>
                      <td class="px-2 py-2 border-r border-gray-200">${tuyen.BenDen || ''}</td>
                      <td class="px-2 py-2 border-r border-gray-200 text-justify">${tuyen.HanhTrinh || ''}</td>
                      <td class="px-2 py-2 text-center border-r border-gray-200">${tuyen.CuLyTuyen_km || ''}</td>
                      <td class="px-2 py-2 text-center border-r border-gray-200">${tuyen.TongChuyenThang || ''}</td>
                      <td class="px-2 py-2 text-center border-r border-gray-200">${tuyen.ChuyenDaKhaiThac || '0'}</td>
                     <td class="px-2 py-2 text-center border-r border-gray-200 ${remainingCapacity > 0 ? 'text-green-600' : 'text-red-600'}">${remainingCapacity}</td>
                     <td class="px-2 py-2 text-center border-r border-gray-200">${tuyen.GianCachToiThieu_phut || ''}</td>
                     <td class="px-2 py-2 text-center">
                         <button onclick="event.stopPropagation(); showRouteDetail('${tuyen.MaSoTuyen}')" 
                                 class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                             üöå Chi ti·∫øt
                         </button>
                     </td>
                 </tr>
             `;
           });

           tableBody.innerHTML = html;
       }

       // Setup filter options
       function setupFilterOptions() {
           const tinhDiSet = new Set();
           const tinhDenSet = new Set();
           const benDiSet = new Set();
           const benDenSet = new Set();
           const phanLoaiSet = new Set();
           const donViKhaiThacSet = new Set();

           // Get data from tuyen
           allTuyenData.forEach(tuyen => {
               if (tuyen.TinhDi) tinhDiSet.add(tuyen.TinhDi);
               if (tuyen.TinhDen) tinhDenSet.add(tuyen.TinhDen);
               if (tuyen.BenDi) benDiSet.add(tuyen.BenDi);
               if (tuyen.BenDen) benDenSet.add(tuyen.BenDen);
               if (tuyen.PhanLoaiTuyen) phanLoaiSet.add(tuyen.PhanLoaiTuyen);
           });

           // Get don vi khai thac from thong bao data
           allThongBaoData.forEach(tb => {
               if (tb['ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i']) {
                   donViKhaiThacSet.add(tb['ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i']);
               }
           });

           // Populate filter dropdowns
           const filterTinhDi = document.getElementById('filterTinhDi');
           const filterTinhDen = document.getElementById('filterTinhDen');
           const filterBenDi = document.getElementById('filterBenDi');
           const filterBenDen = document.getElementById('filterBenDen');
           const filterPhanLoai = document.getElementById('filterPhanLoai');
           const filterDonViKhaiThac = document.getElementById('filterDonViKhaiThac');

           // Clear existing options (except "T·∫•t c·∫£")
           filterTinhDi.innerHTML = '<option value="">T·∫•t c·∫£</option>';
           filterTinhDen.innerHTML = '<option value="">T·∫•t c·∫£</option>';
           filterBenDi.innerHTML = '<option value="">T·∫•t c·∫£</option>';
           filterBenDen.innerHTML = '<option value="">T·∫•t c·∫£</option>';
           filterPhanLoai.innerHTML = '<option value="">T·∫•t c·∫£</option>';
           filterDonViKhaiThac.innerHTML = '<option value="">T·∫•t c·∫£</option>';

           // Add options
           Array.from(tinhDiSet).sort().forEach(item => {
               filterTinhDi.innerHTML += `<option value="${item}">${item}</option>`;
           });

           Array.from(tinhDenSet).sort().forEach(item => {
               filterTinhDen.innerHTML += `<option value="${item}">${item}</option>`;
           });

           Array.from(benDiSet).sort().forEach(item => {
               filterBenDi.innerHTML += `<option value="${item}">${item}</option>`;
           });

           Array.from(benDenSet).sort().forEach(item => {
               filterBenDen.innerHTML += `<option value="${item}">${item}</option>`;
           });

           Array.from(phanLoaiSet).sort().forEach(item => {
               filterPhanLoai.innerHTML += `<option value="${item}">${item}</option>`;
           });

           Array.from(donViKhaiThacSet).sort().forEach(item => {
               filterDonViKhaiThac.innerHTML += `<option value="${item}">${item}</option>`;
           });
       }

       // Parse distance filter
       function parseDistanceFilter(filterValue) {
           if (!filterValue) return null;

           filterValue = filterValue.trim();

           // Format: 50-100
           if (filterValue.includes('-')) {
               const parts = filterValue.split('-');
               if (parts.length === 2) {
                   const min = parseFloat(parts[0].trim());
                   const max = parseFloat(parts[1].trim());
                   return { min: isNaN(min) ? null : min, max: isNaN(max) ? null : max };
               }
           }

           // Format: >50
           if (filterValue.startsWith('>')) {
               const value = parseFloat(filterValue.substring(1).trim());
               return { min: isNaN(value) ? null : value, max: null };
           }

           // Format: <100
           if (filterValue.startsWith('<')) {
               const value = parseFloat(filterValue.substring(1).trim());
               return { min: null, max: isNaN(value) ? null : value };
           }

           // Format: =50 or just 50
           const cleanValue = filterValue.startsWith('=') ? filterValue.substring(1).trim() : filterValue;
           const value = parseFloat(cleanValue);
           if (!isNaN(value)) {
               return { min: value, max: value };
           }

           return null;
       }

       // Check if distance matches filter
       function matchesDistanceFilter(distance, filter) {
           if (!filter) return true;

           const dist = parseFloat(distance);
           if (isNaN(dist)) return false;

           if (filter.min !== null && dist < filter.min) return false;
           if (filter.max !== null && dist > filter.max) return false;

           return true;
       }

       // Toggle advanced search panel
       function toggleAdvancedSearch() {
           const panel = document.getElementById('advancedSearchPanel');
           panel.classList.toggle('open');
       }

       // Perform search (both basic and advanced)
       function performSearch() {
           const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
           const tinhDi = document.getElementById('filterTinhDi').value;
           const tinhDen = document.getElementById('filterTinhDen').value;
           const benDi = document.getElementById('filterBenDi').value;
           const benDen = document.getElementById('filterBenDen').value;
           const phanLoai = document.getElementById('filterPhanLoai').value;
           const cuLyFilter = document.getElementById('filterCuLy').value;
           const donViKhaiThac = document.getElementById('filterDonViKhaiThac').value;
           const tinhTrangTuyen = document.getElementById('filterTinhTrangTuyen').value;

           // Check if any advanced filter is applied
           const hasAdvancedFilter = tinhDi || tinhDen || benDi || benDen || phanLoai || cuLyFilter || donViKhaiThac || tinhTrangTuyen;

           const distanceFilter = parseDistanceFilter(cuLyFilter);

           filteredTuyenData = allTuyenData.filter(tuyen => {
               // Basic search filter
               const matchesSearch = !searchTerm ||
                   (tuyen.MaSoTuyen && tuyen.MaSoTuyen.toLowerCase().includes(searchTerm)) ||
                   (tuyen.TenTuyen && tuyen.TenTuyen.toLowerCase().includes(searchTerm)) ||
                   (tuyen.TinhDi && tuyen.TinhDi.toLowerCase().includes(searchTerm)) ||
                   (tuyen.TinhDen && tuyen.TinhDen.toLowerCase().includes(searchTerm)) ||
                   (tuyen.BenDi && tuyen.BenDi.toLowerCase().includes(searchTerm)) ||
                   (tuyen.BenDen && tuyen.BenDen.toLowerCase().includes(searchTerm)) ||
                   (tuyen.HanhTrinh && tuyen.HanhTrinh.toLowerCase().includes(searchTerm));

               // Advanced filters
               const matchesTinhDi = !tinhDi || tuyen.TinhDi === tinhDi;
               const matchesTinhDen = !tinhDen || tuyen.TinhDen === tinhDen;
               const matchesBenDi = !benDi || tuyen.BenDi === benDi;
               const matchesBenDen = !benDen || tuyen.BenDen === benDen;
               const matchesPhanLoai = !phanLoai || tuyen.PhanLoaiTuyen === phanLoai;

               // Distance filter
               const matchesDistance = matchesDistanceFilter(tuyen.CuLyTuyen_km, distanceFilter);

               // Don vi khai thac filter
               let matchesDonVi = true;
               if (donViKhaiThac) {
                   const tuyenThongBao = allThongBaoData.filter(tb =>
                       tb.Ref_Tuyen === tuyen.MaSoTuyen &&
                       (!tb.TrangThai || tb.TrangThai !== 'H·∫øt hi·ªáu l·ª±c')
                   );
                   matchesDonVi = tuyenThongBao.some(tb =>
                       tb['ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i'] === donViKhaiThac
                   );
               }

               // Tinh trang tuyen filter
               let matchesTinhTrang = true;
               if (tinhTrangTuyen) {
                   const currentStatus = getRouteStatus(tuyen);
                   matchesTinhTrang = currentStatus === tinhTrangTuyen;
               }

               return matchesSearch && matchesTinhDi && matchesTinhDen && matchesBenDi &&
                   matchesBenDen && matchesPhanLoai && matchesDistance &&
                   matchesDonVi && matchesTinhTrang;
           });

           displayRouteList(filteredTuyenData);

           // Show applied filters if any advanced filter is used
           if (hasAdvancedFilter) {
               showAppliedFilters();
           }
       }

       // Clear advanced filter
       function clearAdvancedFilter() {
           document.getElementById('searchInput').value = '';
           document.getElementById('filterTinhDi').value = '';
           document.getElementById('filterTinhDen').value = '';
           document.getElementById('filterBenDi').value = '';
           document.getElementById('filterBenDen').value = '';
           document.getElementById('filterPhanLoai').value = '';
           document.getElementById('filterCuLy').value = '';
           document.getElementById('filterDonViKhaiThac').value = '';
           document.getElementById('filterTinhTrangTuyen').value = '';

           // Reset to all data
           filteredTuyenData = allTuyenData;
           displayRouteList(filteredTuyenData);
       }

       // Show applied filters (optional visual feedback)
       function showAppliedFilters() {
           const filters = [];
           const tinhDi = document.getElementById('filterTinhDi').value;
           const tinhDen = document.getElementById('filterTinhDen').value;
           const benDi = document.getElementById('filterBenDi').value;
           const benDen = document.getElementById('filterBenDen').value;
           const phanLoai = document.getElementById('filterPhanLoai').value;
           const cuLy = document.getElementById('filterCuLy').value;
           const donViKhaiThac = document.getElementById('filterDonViKhaiThac').value;
           const tinhTrangTuyen = document.getElementById('filterTinhTrangTuyen').value;

           if (tinhDi) filters.push(`T·ªânh ƒëi: ${tinhDi}`);
           if (tinhDen) filters.push(`T·ªânh ƒë·∫øn: ${tinhDen}`);
           if (benDi) filters.push(`B·∫øn ƒëi: ${benDi}`);
           if (benDen) filters.push(`B·∫øn ƒë·∫øn: ${benDen}`);
           if (phanLoai) filters.push(`Ph√¢n lo·∫°i: ${phanLoai}`);
           if (cuLy) filters.push(`C·ª± ly: ${cuLy} km`);
           if (donViKhaiThac) filters.push(`ƒê∆°n v·ªã: ${donViKhaiThac}`);
           if (tinhTrangTuyen) filters.push(`T√¨nh tr·∫°ng: ${tinhTrangTuyen}`);

           if (filters.length > 0) {
               console.log('ƒê√£ √°p d·ª•ng b·ªô l·ªçc:', filters.join(', '));
           }
       }

       // Setup search functionality
       function setupSearch() {
           const searchInput = document.getElementById('searchInput');

           // Search on Enter key
           searchInput.addEventListener('keypress', function (e) {
               if (e.key === 'Enter') {
                   performSearch();
               }
           });
       }

       // Setup auto search when filter values change
       function setupAutoSearch() {
           // Auto search when filter values change
           const filterElements = [
               'filterTinhDi', 'filterTinhDen', 'filterBenDi', 'filterBenDen',
               'filterPhanLoai', 'filterDonViKhaiThac', 'filterTinhTrangTuyen'
           ];

           filterElements.forEach(id => {
               const element = document.getElementById(id);
               if (element) {
                   element.addEventListener('change', performSearch);
               }
           });

           // Distance filter with debounce
           const cuLyInput = document.getElementById('filterCuLy');
           if (cuLyInput) {
               let timeout;
               cuLyInput.addEventListener('input', function () {
                   clearTimeout(timeout);
                   timeout = setTimeout(performSearch, 500); // Debounce 500ms
               });
           }
       }

       // Show route detail
       function showRouteDetail(maSoTuyen) {
           const selectedTuyen = allTuyenData.find(t => t.MaSoTuyen === maSoTuyen);
           if (!selectedTuyen) {
               alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin tuy·∫øn');
               return;
           }

           // Filter data for selected route
           const filteredThongBao = allThongBaoData.filter(tb => tb.Ref_Tuyen === maSoTuyen);
           const thongBaoIds = filteredThongBao.map(tb => tb.SoThongBao);
           const filteredChiTiet = allChiTietData.filter(ct =>
               ct.SoThongBao && thongBaoIds.includes(ct.SoThongBao)
           );

           // Display data
           displayTuyenInfo(selectedTuyen);
           displayThongBaoTable(filteredThongBao);
           generateScheduleTable(filteredThongBao, filteredChiTiet);

           // Update current time
           document.getElementById('current-time').textContent = new Date().toLocaleString('vi-VN');

           // Switch to detail view
           document.getElementById('routeListContent').style.display = 'none';
           document.getElementById('routeDetailContent').style.display = 'block';
       }

       // Back to list
       function backToList() {
           document.getElementById('routeDetailContent').style.display = 'none';
           document.getElementById('routeListContent').style.display = 'block';
       }

       // Display route information
       function displayTuyenInfo(tuyenData) {
           const tuyenInfoDiv = document.getElementById('tuyenInfo');

           const infoHTML = `
             <div class="space-y-0">
                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         M√£ s·ªë tuy·∫øn:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.MaSoTuyen || ''}</div>
                 </div>
                 
                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         T√™n tuy·∫øn:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TenTuyen || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         T·ªânh n∆°i ƒëi:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhDi || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         T·ªânh n∆°i ƒë·∫øn:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhDen || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         BX ƒëi:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.BenDi || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         BX ƒë·∫øn:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.BenDen || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 text-sm font-bold flex relative">
                         H√†nh tr√¨nh ch·∫°y xe:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex font-medium text-justify">
                         ${tuyenData.HanhTrinh || ''}
                     </div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         Ph√¢n lo·∫°i tuy·∫øn:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.PhanLoaiTuyen || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         T√¨nh tr·∫°ng khai th√°c tuy·∫øn:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TinhTrangKhaiThac || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         C·ª± ly Tuy·∫øn (km):
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.CuLyTuyen_km || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         T·ªïng s·ªë chuy·∫øn xe ƒë∆∞·ª£c khai th√°c (chuy·∫øn/ th√°ng):
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.TongChuyenThang || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         T·ªïng s·ªë chuy·∫øn xe ƒë√£ c√≥ ƒë∆°n v·ªã tham gia khai th√°c (chuy·∫øn/ th√°ng):
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.ChuyenDaKhaiThac || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         Th·ªùi gian gi√£n c√°ch t·ªëi thi·ªÉu gi·ªØa c√°c chuy·∫øn xe li√™n k·∫ø (ph√∫t/ chuy·∫øn):
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.GianCachToiThieu_phut || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         Quy·∫øt ƒë·ªãnh ban h√†nh:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.SoQuyetDinh || ''}</div>
                 </div>

                 <div class="grid grid-cols-9 border-gray-200">
                     <div class="col-span-4 font-bold flex items-center relative">
                         Ng√†y ban h√†nh:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${formatDate(tuyenData.NgayBanHanh) || ''}</div>
                 </div>

                 <div class="grid grid-cols-9">
                     <div class="col-span-4 font-bold flex items-center relative">
                         ƒê∆°n v·ªã ban h√†nh:
                         <div class="absolute right-0 w-1 gradient-secondary"></div>
                     </div>
                     <div class="col-span-5 text-sm text-gray-800 flex items-center font-medium">${tuyenData.DonViBanHanh || ''}</div>
                 </div>
             </div>
         `;

           tuyenInfoDiv.innerHTML = infoHTML;
       }

       // Display notification table
       function displayThongBaoTable(thongBaoList) {
           const tableBody = document.getElementById('thongBaoTable');

           const activeThongBao = thongBaoList.filter(thongBao =>
               !thongBao.TrangThai || thongBao.TrangThai !== 'H·∫øt hi·ªáu l·ª±c'
           );

           if (!activeThongBao || activeThongBao.length === 0) {
               tableBody.innerHTML = `
                 <tr>
                     <td colspan="7" class="text-center py-8 text-gray-500 italic border border-gray-200">
                         Ch∆∞a c√≥ th√¥ng b√°o ƒëang c√≥ hi·ªáu l·ª±c
                     </td>
                 </tr>
             `;
               return;
           }

           let html = '';
           activeThongBao.forEach((thongBao, index) => {
               const fileData = thongBao.File && thongBao.File.trim() !== '' ? thongBao.File.trim() : null;
               const hasFile = fileData && fileData !== '';

               html += `
                 <tr class="even:bg-blue-50">
                     <td class="py-3 px-3 text-center border border-gray-200 text-xs">${index + 1}.</td>
                     <td class="py-3 px-3 text-center border border-gray-200 text-xs">${thongBao.SoThongBao || ''}</td>
                     <td class="py-3 px-3 text-center border border-gray-200 text-xs">${formatDate(thongBao.NgayBanHanh) || ''}</td>
                     <td class="py-3 px-3 text-center border border-gray-200 text-xs">${thongBao.NgayBatDau || ''}</td>
                     <td class="py-3 px-3 border border-gray-200 text-xs">${thongBao['ƒê∆°n v·ªã kinh doanh v·∫≠n t·∫£i'] || ''}</td>
                     <td class="py-3 px-3 border border-gray-200 text-xs">${thongBao.CQBanHanh || ''}</td>
                     <td class="py-4 px-3 text-center border border-gray-200">
                         <div class="flex justify-center gap-2">
                             ${hasFile ? `
                                 <div class="w-8 h-8 gradient-blue text-white flex items-center justify-center rounded-lg cursor-pointer text-sm hover:opacity-80 transition-opacity" 
                                      title="M·ªü file ƒë√≠nh k√®m" 
                                      onclick="openAppSheetFile('${fileData.replace(/'/g, "\\'")}')">
                                     üìÑ
                                 </div>
                             ` : `
                                 <div class="w-8 h-8 bg-gray-300 text-gray-500 flex items-center justify-center rounded-lg text-sm" 
                                      title="Kh√¥ng c√≥ file ƒë√≠nh k√®m">
                                     üìÑ
                                 </div>
                             `}
                         </div>
                     </td>
                 </tr>
             `;
           });

           tableBody.innerHTML = html;
       }

       // Open AppSheet file
       function openAppSheetFile(fileData) {
           if (!fileData || fileData.trim() === '') {
               alert('Kh√¥ng c√≥ file ƒë√≠nh k√®m');
               return;
           }

           try {
               console.log('File data received:', fileData);

               if (fileData.startsWith('https://www.appsheet.com/template/gettablefileurl') ||
                   fileData.startsWith('https://') && fileData.includes('appsheet.com')) {
                   console.log('Opening direct URL:', fileData);
                   window.open(fileData, '_blank');
               } else {
                   console.log('Creating URL for file:', fileData);
                   const baseUrl = 'https://www.appsheet.com/template/gettablefileurl';
                   const appName = 'QLVT-691992930';
                   const tableName = 'THONGBAO_KHAITHAC';

                   const fileUrl = `${baseUrl}?appName=${appName}&tableName=${tableName}&fileName=${encodeURIComponent(fileData)}`;

                   console.log('Generated URL:', fileUrl);
                   window.open(fileUrl, '_blank');
               }
           } catch (error) {
               console.error('L·ªói khi m·ªü file:', error);
               alert('Kh√¥ng th·ªÉ m·ªü file. Vui l√≤ng th·ª≠ l·∫°i sau.');
           }
       }

       // Generate schedule table
       function generateScheduleTable(thongBaoList, chiTietList) {
           const bieuDoDiv = document.getElementById('bieuDoXeChay');

           if (!chiTietList || chiTietList.length === 0) {
               bieuDoDiv.innerHTML = `
                 <div class="text-center py-8 text-gray-500 italic">
                     Ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt xe ch·∫°y
                 </div>
             `;
               return;
           }

           const activeThongBaoIds = thongBaoList
               .filter(tb => !tb.TrangThai || tb.TrangThai !== 'H·∫øt hi·ªáu l·ª±c')
               .map(tb => tb.SoThongBao);

           const validChiTiet = chiTietList.filter(ct =>
               ct.SoThongBao && activeThongBaoIds.includes(ct.SoThongBao)
           );

           if (validChiTiet.length === 0) {
               bieuDoDiv.innerHTML = `
                 <div class="text-center py-8 text-gray-500 italic">
                     Ch∆∞a c√≥ d·ªØ li·ªáu chi ti·∫øt xe ch·∫°y cho c√°c th√¥ng b√°o c√≥ hi·ªáu l·ª±c
                 </div>
             `;
               return;
           }

           const groupedByThongBao = {};
           validChiTiet.forEach(ct => {
               const thongBaoId = ct.SoThongBao;
               if (!groupedByThongBao[thongBaoId]) {
                   groupedByThongBao[thongBaoId] = [];
               }
               groupedByThongBao[thongBaoId].push(ct);
           });

           const thongBaoKeys = Object.keys(groupedByThongBao);

           // Generate table for first half of month (1-15)
           let html = `
             <table class="w-full border-collapse text-xs bg-white">
                 <thead>
                     <tr>
                         <th rowspan="2" class="gradient-secondary text-white py-3 px-2 text-center border-2 border-gray-300 font-bold text-xs uppercase min-w-[60px]">STB</th>
         `;

           // Generate headers for days 1-15
           for (let day = 1; day <= 15; day++) {
               html += `
                 <th colspan="2" class="gradient-table py-3 px-2 text-center border-2 border-gray-300 font-bold text-gray-700 text-xs uppercase min-w-[80px]">
                     Ng√†y ${day}
                 </th>
             `;
           }

           html += `</tr><tr>`;

           // Generate sub-headers (ƒêi/V·ªÅ)
           for (let day = 1; day <= 15; day++) {
               html += `
                 <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">ƒêi</th>
                 <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">V·ªÅ</th>
             `;
           }

           html += `</tr></thead><tbody>`;

           // Generate rows for each th√¥ng b√°o
           thongBaoKeys.forEach((thongBaoId, index) => {
               const stbShort = thongBaoId.split('/')[0];
               html += `<tr><td class="gradient-secondary text-white py-2 px-1 text-center font-bold text-xs">${stbShort}</td>`;

               for (let day = 1; day <= 15; day++) {
                   const chiTietDi = groupedByThongBao[thongBaoId].filter(ct =>
                       ct.Chieu === 'ƒêi' &&
                       ct.NgayHoatDong && (
                           ct.NgayHoatDong.toString() === day.toString() ||
                           ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                           ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                       )
                   );

                   const chiTietVe = groupedByThongBao[thongBaoId].filter(ct =>
                       ct.Chieu === 'V·ªÅ' &&
                       ct.NgayHoatDong && (
                           ct.NgayHoatDong.toString() === day.toString() ||
                           ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                           ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                       )
                   );

                   html += `
                     <td class="text-center bg-amber-200 h-15 align-top pt-1">
                         ${chiTietDi.length > 0 ?
                           chiTietDi.map(ct =>
                               `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                           ).join('') :
                           `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                       }
                     </td>
                     <td class="text-center bg-amber-200 h-15 align-top pt-1">
                         ${chiTietVe.length > 0 ?
                           chiTietVe.map(ct =>
                               `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                           ).join('') :
                           `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                       }
                     </td>
                 `;
               }

               html += `</tr>`;
           });

           html += `</tbody></table>`;

           // Generate table for second half of month (16-31)
           html += `
             <div class="gradient-primary text-white text-center py-5 font-bold text-base uppercase tracking-wider">
                 Gi·ªù xu·∫•t b·∫øn
             </div>
             <table class="w-full border-collapse text-xs bg-white">
                 <thead>
                     <tr>
                         <th rowspan="2" class="gradient-secondary text-white py-3 px-2 text-center border-2 border-gray-300 font-bold text-xs uppercase min-w-[60px]">STB</th>
         `;

           // Generate headers for days 16-31
           for (let day = 16; day <= 31; day++) {
               html += `
                 <th colspan="2" class="gradient-table py-3 px-2 text-center border-2 border-gray-300 font-bold text-gray-700 text-xs uppercase min-w-[80px]">
                     Ng√†y ${day}
                 </th>
             `;
           }

           html += `</tr><tr>`;

           // Generate sub-headers (ƒêi/V·ªÅ)
           for (let day = 16; day <= 31; day++) {
               html += `
                 <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">ƒêi</th>
                 <th class="gradient-table py-2 px-1 text-center border border-gray-300 text-xs">V·ªÅ</th>
             `;
           }

           html += `</tr></thead><tbody>`;

           // Generate rows for each th√¥ng b√°o (16-31)
           thongBaoKeys.forEach((thongBaoId, index) => {
               const stbShort = thongBaoId.split('/')[0];
               html += `<tr><td class="gradient-secondary text-white py-2 px-1 text-center font-bold text-xs">${stbShort}</td>`;

               for (let day = 16; day <= 31; day++) {
                   const chiTietDi = groupedByThongBao[thongBaoId].filter(ct =>
                       ct.Chieu === 'ƒêi' &&
                       ct.NgayHoatDong && (
                           ct.NgayHoatDong.toString() === day.toString() ||
                           ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                           ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                       )
                   );

                   const chiTietVe = groupedByThongBao[thongBaoId].filter(ct =>
                       ct.Chieu === 'V·ªÅ' &&
                       ct.NgayHoatDong && (
                           ct.NgayHoatDong.toString() === day.toString() ||
                           ct.NgayHoatDong.toString().split(',').map(d => d.trim()).includes(day.toString()) ||
                           ct.NgayHoatDong.toString().split(' ').includes(day.toString())
                       )
                   );

                   html += `
                     <td class="text-center bg-amber-200 h-15 align-top pt-1">
                         ${chiTietDi.length > 0 ?
                           chiTietDi.map(ct =>
                               `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                           ).join('') :
                           `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                       }
                     </td>
                     <td class="text-center bg-amber-200 h-15 align-top pt-1">
                         ${chiTietVe.length > 0 ?
                           chiTietVe.map(ct =>
                               `<div class="bg-lime-300 text-xs py-1 px-1 font-bold shadow-sm mb-1 rounded">${ct.GioXuatBen || ''}</div>`
                           ).join('') :
                           `<div class="bg-gray-100 h-6 shadow-sm rounded"></div>`
                       }
                     </td>
                 `;
               }

               html += `</tr>`;
           });

           html += `</tbody></table>`;

           bieuDoDiv.innerHTML = html;
       }

       // Main initialization function
       async function initialize() {
           try {
               console.log('Starting initialization...');

               const startTime = performance.now();
               const { tuyenData, thongBaoData, chiTietData } = await loadAllDataParallel();
               const loadTime = performance.now() - startTime;
               console.log(`Data loaded in ${loadTime.toFixed(2)}ms`);

               updateProgress(70, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...');

               // Store data globally
               allTuyenData = tuyenData;
               allThongBaoData = thongBaoData;
               allChiTietData = chiTietData;
               filteredTuyenData = tuyenData;

               console.log('Total routes:', allTuyenData.length);
               console.log('Total notifications:', allThongBaoData.length);
               console.log('Total details:', allChiTietData.length);

               updateProgress(80, 'ƒêang hi·ªÉn th·ªã danh s√°ch tuy·∫øn...');

               // Setup filter options
               setupFilterOptions();

               // Display route list
               displayRouteList(filteredTuyenData);

               updateProgress(90, 'Thi·∫øt l·∫≠p t√¨m ki·∫øm...');

               // Setup search functionality
               setupSearch();
               setupAutoSearch();

               // Update current time
               document.getElementById('current-time-list').textContent = new Date().toLocaleString('vi-VN');

               updateProgress(100, 'T·∫£i th√†nh c√¥ng!');

               // Hide loading message and show route list
               setTimeout(() => {
                   document.getElementById('loadingMessage').style.display = 'none';
                   document.getElementById('routeListContent').style.display = 'block';
               }, 500);

               const totalTime = performance.now() - startTime;
               console.log(`Total processing time: ${totalTime.toFixed(2)}ms`);

           } catch (error) {
               console.error('Initialization failed:', error);
               document.getElementById('loadingMessage').innerHTML = `
                 <div class="text-center py-20">
                     <div class="text-red-600 text-lg font-bold mb-4">L·ªói t·∫£i d·ªØ li·ªáu</div>
                     <p class="text-gray-600">${error.message}</p>
                     <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                         Th·ª≠ l·∫°i
                     </button>
                 </div>
             `;
           }
       }

       // Utility functions
       function printDocument() {
           window.print();
       }

       // Add keyboard shortcuts
       document.addEventListener('keydown', function (e) {
           if (e.ctrlKey && e.key === 'p') {
               e.preventDefault();
               printDocument();
           }
           if (e.key === 'Escape') {
               // Press Escape to go back to list or close advanced search
               if (document.getElementById('routeDetailContent').style.display === 'block') {
                   backToList();
               } else if (document.getElementById('advancedSearchPanel').classList.contains('open')) {
                   toggleAdvancedSearch();
               }
           }
       });

       // Initialize when page loads
       document.addEventListener('DOMContentLoaded', initialize);

       // Add some responsive behavior for search input
       document.addEventListener('DOMContentLoaded', function () {
           const searchInput = document.getElementById('searchInput');
           if (searchInput) {
               searchInput.addEventListener('focus', function () {
                   this.style.borderColor = '#3b82f6';
                   this.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
               });

               searchInput.addEventListener('blur', function () {
                   this.style.borderColor = '#d1d5db';
                   this.style.boxShadow = 'none';
               });
           }

           // Add placeholder text and examples for distance filter
           const cuLyInput = document.getElementById('filterCuLy');
           if (cuLyInput) {
               cuLyInput.addEventListener('focus', function () {
                   if (!this.value) {
                       this.placeholder = '10-50, >10, <50';
                   }
               });

               cuLyInput.addEventListener('blur', function () {
                   if (!this.value) {
                       this.placeholder = '10-50, >10, <50';
                   }
               });
           }
       });
   </script>

   <!-- Print styles -->
   <style>
       @media print {
           body {
               background: white !important;
               padding: 0 !important;
           }

           #routeListContent,
           #routeDetailContent {
               box-shadow: none !important;
               border: none !important;
           }

           .no-print {
               display: none !important;
           }

           table {
               page-break-inside: auto;
           }

           tr {
               page-break-inside: avoid;
               page-break-after: auto;
           }

           thead {
               display: table-header-group;
           }

           tfoot {
               display: table-footer-group;
           }
       }

       /* Responsive design */
       @media (max-width: 1200px) {

           .grid-cols-6 {
               grid-template-columns: 1fr 2fr;
           }

           h1 {
               font-size: 1.5rem;
           }

           .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-8 {
               grid-template-columns: repeat(2, 1fr);
           }
       }

       @media (max-width: 768px) {
           .grid-cols-6 {
               grid-template-columns: 1fr;
           }

           .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-8 {
               grid-template-columns: 1fr;
           }

           table {
               font-size: 10px;
           }

           .px-8 {
               padding-left: 1rem;
               padding-right: 1rem;
           }

           /* Stack search elements vertically on mobile */
           .flex.items-center.gap-4 {
               flex-direction: column;
               align-items: stretch;
               gap: 10px;
           }

           .flex-1 {
               width: 100%;
           }

           /* Hide some table columns on mobile */
           .mobile-hidden {
               display: none;
           }

           /* Make advanced search panel more mobile friendly */
           .filter-panel.open {
               max-height: 800px;
           }
       }

       /* Additional styling for better UX */
       .hover-effect:hover {
           transform: translateY(-2px);
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
           transition: all 0.3s ease;
       }

       .fade-in {
           animation: fadeIn 0.5s ease-in;
       }

       @keyframes fadeIn {
           from {
               opacity: 0;
               transform: translateY(20px);
           }

           to {
               opacity: 1;
               transform: translateY(0);
           }
       }

       /* Custom scrollbar */
       ::-webkit-scrollbar {
           width: 8px;
           height: 8px;
       }

       ::-webkit-scrollbar-track {
           background: #f1f1f1;
       }

       ::-webkit-scrollbar-thumb {
           background: #4a90e2;
           border-radius: 4px;
       }

       ::-webkit-scrollbar-thumb:hover {
           background: #357abd;
       }

       /* Table styling improvements */
       table {
           border-spacing: 0;
       }

       th,
       td {
           border: 1px solid #e5e7eb;
       }

       .route-row:nth-child(even) {
           background-color: #f9fafb;
       }

       .route-row:hover {
           background-color: #eff6ff !important;
           box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
       }

       /* Button hover effects */
       button:hover {
           transform: translateY(-1px);
           box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
       }

       /* Loading animation improvements */
       .loading {
           margin: 0 auto;
       }

       /* Advanced search panel styling */
       #advancedSearchPanel {
           border-left: 4px solid #3b82f6;
       }

       #advancedSearchPanel.open {
           box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
       }

       /* Filter tab active state */
       .filter-tab.active {
           background-color: #3b82f6;
           color: white;
       }

       /* Responsive table wrapper */
       .table-responsive {
           overflow-x: auto;
           -webkit-overflow-scrolling: touch;
       }

       /* Status indicators */
       .status-active {
           color: #059669;
           font-weight: 600;
       }

       .status-inactive {
           color: #dc2626;
           font-weight: 600;
       }

       /* Tooltip styling */
       [title] {
           cursor: help;
       }

       /* Enhanced distance input styling */
       #filterCuLy {
           background-color: #f8fafc;
           border: 2px solid #e2e8f0;
           transition: all 0.2s ease;
       }

       #filterCuLy:focus {
           background-color: white;
           border-color: #3b82f6;
           box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
       }

       #filterCuLy::placeholder {
           color: #94a3b8;
           font-style: italic;
       }
   </style>

   <!-- Mobile responsive meta tags -->
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

   <!-- Additional mobile styles for table -->
   <style>
       @media (max-width: 640px) {
           .overflow-x-auto {
               max-width: calc(100vw - 1rem);
           }

           table {
               min-width: 1200px;
               /* Ensure table doesn't get too cramped */
           }

           th,
           td {
               white-space: nowrap;
               min-width: 60px;
           }

           .px-4 {
               padding-left: 0.5rem;
               padding-right: 0.5rem;
           }

           .py-3 {
               padding-top: 0.5rem;
               padding-bottom: 0.5rem;
           }
       }
   </style>
</body>

</html>
