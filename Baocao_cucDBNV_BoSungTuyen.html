<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Văn Bổ Sung Tuyến Vào Danh Mục</title>

    <!-- Thêm các thư viện cần thiết cho xuất Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @page {
            size: A4;
            margin: 0;
        }

        body {
            font-family: "Times New Roman", serif;
            font-size: 14px;
            line-height: 1.5;
            background: white;
            width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            min-height: 297mm;
            position: relative;
        }

        .button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            max-width: 250px;
        }

        .input-container {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .input-container label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: bold;
        }

        .input-container input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: "Times New Roman", serif;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .input-container input:last-child {
            margin-bottom: 0;
        }

        .input-container input::placeholder {
            color: #999;
            font-style: italic;
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: "Times New Roman", serif;
        }

        .print-button {
            background-color: #4CAF50;
            color: white;
        }

        .print-button:hover {
            background-color: #45a049;
        }

        .export-button {
            background-color: #2b579a;
            color: white;
        }

        .export-button:hover {
            background-color: #1e3f6f;
        }

        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
        }

        .hidden {
            display: none;
        }

        /* Document header styling */
        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .header-left {
            font-size: 13px;
            width: 40%;
            text-align: center;
        }

        .header-left .ubnd {
            margin-bottom: 2px;
        }

        .header-left .so-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header-left .underline {
            border-bottom: 1px solid #000;
            width: 60px;
            margin: 2px auto 8px auto;
        }

        .header-left .so-vb {
            font-size: 13px;
        }

        .header-right {
            text-align: center;
            font-size: 13px;
            width: 55%;
        }

        .header-right .country {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .header-right .motto {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header-right .underline-motto {
            border-bottom: 1px solid #000;
            width: 150px;
            margin: 0 auto 8px auto;
        }

        .header-right .location-date {
            font-style: italic;
        }

        /* Subject line */
        .subject-line {
            margin: 15px 0;
            text-align: left;
        }

        .subject-line .label {
            font-style: italic;
            font-size: 13px;
            margin-bottom: 3px;
        }

        /* Recipient */
        .recipient {
            margin: 20px 0;
        }

        .recipient .kinh-gui {
            font-weight: bold;
        }

        /* Content styling */
        .document-content {
            margin: 15px 0;
            text-align: justify;
            line-height: 1.8;
        }

        .document-content p {
            margin-bottom: 8px;
            text-indent: 30px;
        }

        .document-content .no-indent {
            text-indent: 0;
        }

        /* Table styling - theo mẫu Word */
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }

        .info-table th,
        .info-table td {
            border: 1px solid #000;
            padding: 6px;
            text-align: center;
            vertical-align: middle;
        }

        .info-table th {
            font-weight: bold;
            background-color: #f0f0f0;
        }

        .info-table .text-left {
            text-align: left;
        }

        .info-table .text-center {
            text-align: center;
        }

        /* Footer/Signature section */
        .footer-section {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }

        .footer-left {
            width: 40%;
            font-size: 12px;
        }

        .footer-left .noi-nhan {
            font-weight: bold;
            font-style: italic;
        }

        .footer-left p {
            margin: 2px 0;
        }

        .footer-right {
            width: 50%;
            text-align: center;
        }

        .footer-right .title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .footer-right .sub-title {
            font-weight: bold;
            margin-bottom: 60px;
        }

        .footer-right .name {
            font-weight: bold;
        }

        @media print {
            body {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 20mm;
            }

            .button-container {
                display: none;
            }
        }

        @media screen {
            body {
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                margin: 20px auto;
            }
        }

        .bold {
            font-weight: bold;
        }

        .italic {
            font-style: italic;
        }
    </style>
</head>

<body>
    <!-- Button Container - CHỈ 4 TRƯỜNG NHẬP -->
    <div class="button-container">
        <div class="input-container">
            <label for="so-vb-dx">Số VB đề xuất:</label>
            <input type="text" id="so-vb-dx" placeholder="VD: 12/SXD-VT&ATGT" />

            <label for="ngay-dx">Ngày VB đề xuất:</label>
            <input type="date" id="ngay-dx" />

            <label for="so-vb-ct">Số VB chấp thuận:</label>
            <input type="text" id="so-vb-ct" placeholder="VD: 34/SXD-VT&ATGT" />

            <label for="ngay-ct">Ngày VB chấp thuận:</label>
            <input type="date" id="ngay-ct" />
        </div>

        <button class="button print-button" onclick="window.print()">
            <i class="fas fa-print"></i> In Tài Liệu
        </button>
        <button class="button export-button" onclick="exportToWordTemplate()">
            <i class="fas fa-file-word"></i> Xuất Word
        </button>
    </div>

    <!-- Loading Message -->
    <div id="loading-message">Đang tải dữ liệu...</div>

    <!-- ===== TRANG 1: CÔNG VĂN GỬI CỤC ĐBVN ===== -->
    <div class="document-header">
        <div class="header-left">
            <div class="ubnd">UBND TỈNH <span id="ref-tinh-di-upper">...</span></div>
            <div class="so-name">SỞ XÂY DỰNG</div>
            <div class="underline"></div>
            <div class="so-vb">Số: <span id="so-cong-van">...</span>/SXD-VT&ATGT</div>
        </div>
        <div class="header-right">
            <div class="country">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
            <div class="motto">Độc lập - Tự do - Hạnh phúc</div>
            <div class="underline-motto"></div>
            <div class="location-date">
                <span id="ref-tinh-di">...</span>, ngày <span id="ngay">...</span> tháng <span id="thang">...</span> năm
                <span id="nam">...</span>
            </div>
        </div>
    </div>

    <div class="subject-line">
        <div class="label">
            V/v đề xuất bổ sung tuyến <span id="ref-ben-di">...</span> đi Bến xe <span id="ref-ben-den">...</span><br>
            vào Danh mục mạng lưới tuyến vận tải hành khách cố định bằng xe ô tô
        </div>
    </div>

    <div class="recipient">
        <span class="kinh-gui">Kính gửi:</span> Cục Đường bộ Việt Nam
    </div>

    <div class="document-content">
        <p>
            Căn cứ Nghị định số 158/2024/NĐ-CP ngày 18/12/2024 của Chính phủ Quy định về hoạt động vận tải đường bộ.
        </p>

        <p>
            Trên cơ sở ý kiến thống nhất của Sở Xây dựng <span id="ref-tinh-den">...</span>, Sở Xây dựng <span id="ref-tinh-di-2">...</span>
            tổng hợp, báo cáo đề xuất Cục Đường bộ Việt Nam bổ sung tuyến sau vào Danh mục chi tiết tuyến vận tải hành khách cố định liên tỉnh toàn quốc.
        </p>

        <p class="no-indent italic">
            (Thông tin chi tiết tuyến tại Phụ lục kèm theo Công văn này)
        </p>

        <p>
            Sở Xây dựng <span id="ref-tinh-di-3">...</span> trân trọng báo cáo./.
        </p>
    </div>

    <div class="footer-section">
        <div class="footer-left">
            <p><span class="noi-nhan">Nơi nhận:</span></p>
            <p>- Như trên;</p>
            <p>- Sở Xây dựng <span id="ref-tinh-den-2">...</span> (p/h);</p>
            <p>- Giám đốc Sở (b/c);</p>
            <p>- Lưu: VT, VT&ATGT.</p>
        </div>
        <div class="footer-right">
            <div class="title">KT. GIÁM ĐỐC</div>
            <div class="sub-title">PHÓ GIÁM ĐỐC</div>
            <div class="name" id="nguoi-ky">Nguyễn Quốc Ân</div>
        </div>
    </div>

    <!-- ===== TRANG 2: PHỤ LỤC THEO MẪU WORD ===== -->
    <div style="page-break-before: always; margin-top: 30px;">
        <h3 style="text-align: center; font-weight: bold; margin-bottom: 15px;">
            PHỤ LỤC: DANH MỤC TUYẾN MỚI ĐỀ NGHỊ BỔ SUNG
        </h3>

        <table class="info-table">
            <thead>
                <tr>
                    <th rowspan="2" style="width:4%;">TT</th>
                    <th rowspan="2" style="width:9%;">Mã số tuyến</th>
                    <th colspan="4">Tên tuyến VTHK cố định liên tỉnh</th>
                    <th rowspan="2" style="width:20%;">Hành trình chạy xe điều chỉnh</th>
                    <th rowspan="2" style="width:7%;">Cự ly tuyến (km)</th>
                    <th rowspan="2" style="width:10%;">Lưu lượng QH (xe xuất bến/tháng)</th>
                    <th rowspan="2" style="width:10%;">TG giãn cách tối thiểu (phút/chuyến)</th>
                    <th rowspan="2" style="width:8%;">Tình trạng tuyến</th>
                    <th rowspan="2" style="width:14%;">Văn bản Sở XD đề xuất</th>
                    <th rowspan="2" style="width:14%;">Văn bản Sở XD chấp thuận</th>
                </tr>
                <tr>
                    <th style="width:8%;">Tỉnh đi</th>
                    <th style="width:8%;">Tỉnh đến</th>
                    <th style="width:10%;">BX đi</th>
                    <th style="width:10%;">BX đến</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="text-center">1</td>
                    <td class="text-center" id="table-ma-so-tuyen">...</td>
                    <td class="text-center" id="table-tinh-di">...</td>
                    <td class="text-center" id="table-tinh-den">...</td>
                    <td class="text-center" id="table-ben-di">...</td>
                    <td class="text-center" id="table-ben-den">...</td>
                    <td class="text-left" id="table-hanh-trinh">...</td>
                    <td class="text-center" id="table-cu-ly">...</td>
                    <td class="text-center" id="table-luu-luong">...</td>
                    <td class="text-center" id="table-gian-cach">...</td>
                    <td class="text-center" id="table-tinh-trang">Tuyến mới</td>
                    <td class="text-left" id="table-vb-dx">[Chưa nhập]</td>
                    <td class="text-left" id="table-vb-ct">[Chưa nhập]</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = '7ee20176-7cb1-4ad4-9d13-e541c8b1b3dc';
        const accessKey = 'V2-EYFgE-X83x3-xFTsK-y3eTp-L9F22-MKoI1-TGU28-sWcWd';
        const region = 'www';

        let globalDocumentData = null;

        // Function to get ID_TB from URL
        function getIDFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ID_TB') || urlParams.get('id_tb');
        }

        // Function to fetch data from AppSheet
        async function fetchAppSheetData(tableName, filter = null) {
            const selector = filter || `Filter(${tableName}, true)`;

            const body = {
                Action: 'Find',
                Properties: {},
                Selector: selector
            };

            const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': accessKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return Array.isArray(data) ? data : [];
        }

        // ===== HÀM FORMAT NGÀY THÁNG THEO QUY TẮC (GIỮ Y NGUYÊN MẪU CỦA BẠN) =====
        function formatDateComponents(date) {
            if (!date || isNaN(date.getTime())) {
                date = new Date();
            }

            const day = date.getDate().toString().padStart(2, '0'); // luôn 2 chữ số
            const month = date.getMonth() + 1; // 1-12
            const year = date.getFullYear(); // 4 chữ số

            // Quy tắc tháng: 1,2 có số 0, 3-12 không có số 0
            let monthStr;
            if (month === 1 || month === 2) monthStr = month.toString().padStart(2, '0');
            else monthStr = month.toString();

            return { day, month: monthStr, year };
        }

        function getCurrentDateComponents() {
            return formatDateComponents(new Date());
        }

        // ===== 4 TRƯỜNG NHẬP =====
        function getSoVBDXFromInput() {
            return document.getElementById('so-vb-dx').value.trim() || '';
        }
        function getNgayDXFromInput() {
            const input = document.getElementById('ngay-dx');
            if (!input.value) return '';
            const d = new Date(input.value);
            const c = formatDateComponents(d);
            return `${c.day}/${c.month}/${c.year}`;
        }

        function getSoVBCTFromInput() {
            return document.getElementById('so-vb-ct').value.trim() || '';
        }
        function getNgayCTFromInput() {
            const input = document.getElementById('ngay-ct');
            if (!input.value) return '';
            const d = new Date(input.value);
            const c = formatDateComponents(d);
            return `${c.day}/${c.month}/${c.year}`;
        }

        function hideLoadingMessage() {
            document.getElementById('loading-message').classList.add('hidden');
        }

        // Populate HTML with data
        function populateHTML(data) {
            const setText = (id, value, fallback = '...') => {
                const el = document.getElementById(id);
                if (el) el.textContent = (value !== undefined && value !== null && value !== '') ? value : fallback;
            };

            // Header
            setText('ref-tinh-di-upper', data.RefTinhdi_upper);
            setText('so-cong-van', data.SoCongVan);
            setText('ref-tinh-di', data.RefTinhdi);
            setText('ngay', data.Ngay);
            setText('thang', data.Thang);
            setText('nam', data.Nam);

            // Subject
            setText('ref-ben-di', data.RefBendi);
            setText('ref-ben-den', data.RefBenden);

            // Body
            setText('ref-tinh-den', data.RefTinhden);
            setText('ref-tinh-di-2', data.RefTinhdi);
            setText('ref-tinh-di-3', data.RefTinhdi);
            setText('ref-tinh-den-2', data.RefTinhden);

            // Table fields
            setText('table-ma-so-tuyen', data.RefMasotuyen);
            setText('table-tinh-di', data.RefTinhdi);
            setText('table-tinh-den', data.RefTinhden);
            setText('table-ben-di', data.RefBendi);
            setText('table-ben-den', data.RefBenden);
            setText('table-hanh-trinh', data.RefHanhtrinh);
            setText('table-cu-ly', data.RefCuly);
            setText('table-luu-luong', data.RefLuuLuongConLai);
            setText('table-gian-cach', data.RefGianCachToiThieu_phut);

            // VB lines in table (đúng kiểu mẫu Word)
            const vbDX = data.SoVBDX && data.NgayDX
                ? `${data.SoVBDX} ngày ${data.NgayDX} của Sở Xây dựng ${data.RefTinhdi}`
                : '[Chưa nhập]';

            const vbCT = data.SoVBCT && data.NgayCT
                ? `${data.SoVBCT} ngày ${data.NgayCT} của Sở Xây dựng ${data.RefTinhden}`
                : '[Chưa nhập]';

            setText('table-vb-dx', vbDX, '[Chưa nhập]');
            setText('table-vb-ct', vbCT, '[Chưa nhập]');
        }

        function updateFromInputs() {
            if (!globalDocumentData) return;

            globalDocumentData.SoVBDX = getSoVBDXFromInput();
            globalDocumentData.NgayDX = getNgayDXFromInput();
            globalDocumentData.SoVBCT = getSoVBCTFromInput();
            globalDocumentData.NgayCT = getNgayCTFromInput();

            populateHTML(globalDocumentData);
        }

        // Load data from AppSheet
        async function loadData() {
            const idTB = getIDFromURL();
            if (!idTB) throw new Error('Không tìm thấy ID_TB trong URL');

            const thongbaoList = await fetchAppSheetData('THONGBAO_KHAITHAC');
            if (!thongbaoList || thongbaoList.length === 0) {
                throw new Error('Không tìm thấy dữ liệu trong bảng THONGBAO_KHAITHAC');
            }

            const thongbaoData = thongbaoList.find(item => {
                const itemId = item['ID_TB'] || item.ID_TB || '';
                return itemId === idTB || itemId.includes(idTB) || idTB.includes(itemId);
            });

            if (!thongbaoData) throw new Error(`Không tìm thấy thông báo với ID: ${idTB}`);

            const currentDate = getCurrentDateComponents();

            globalDocumentData = {
                ID_TB: thongbaoData['ID_TB'] || '',
                SoCongVan: thongbaoData['SoThongBao'] || '',

                RefBendi: thongbaoData['RefBendi'] || '',
                RefBenden: thongbaoData['RefBenden'] || '',
                RefTinhdi: thongbaoData['RefTinhdi'] || '',
                RefTinhden: thongbaoData['RefTinhden'] || '',
                RefTinhdi_upper: (thongbaoData['RefTinhdi'] || '').toUpperCase(),

                RefHanhtrinh: thongbaoData['RefHanhtrinh'] || '',
                RefMasotuyen: thongbaoData['RefMasotuyen'] || '',
                RefCuly: thongbaoData['RefCuly'] || '',
                RefLuuLuongConLai: thongbaoData['RefLuuLuongConLai'] || '',
                RefGianCachToiThieu_phut: thongbaoData['RefGianCachToiThieu_phut'] || '',

                // Ngày tháng công văn = ngày hiện tại (đúng kiểu bạn đang làm)
                Ngay: currentDate.day,
                Thang: currentDate.month,
                Nam: currentDate.year,
                ngay: currentDate.day,
                thang: currentDate.month,
                nam: currentDate.year,

                // 4 input
                SoVBDX: getSoVBDXFromInput(),
                NgayDX: getNgayDXFromInput(),
                SoVBCT: getSoVBCTFromInput(),
                NgayCT: getNgayCTFromInput(),
            };

            populateHTML(globalDocumentData);
            hideLoadingMessage();
        }

        // Export to Word template (Baocao_cucDBNV_BoSungTuyen.docx)
        async function exportToWordTemplate() {
            try {
                if (!globalDocumentData) {
                    alert('Dữ liệu chưa được tải. Vui lòng đợi dữ liệu tải xong.');
                    return;
                }

                updateFromInputs();

                // Validate 4 fields
                if (!globalDocumentData.SoVBDX) {
                    alert('Vui lòng nhập Số VB đề xuất trước khi xuất file Word!');
                    document.getElementById('so-vb-dx').focus();
                    return;
                }
                if (!globalDocumentData.NgayDX) {
                    alert('Vui lòng chọn Ngày VB đề xuất trước khi xuất file Word!');
                    document.getElementById('ngay-dx').focus();
                    return;
                }
                if (!globalDocumentData.SoVBCT) {
                    alert('Vui lòng nhập Số VB chấp thuận trước khi xuất file Word!');
                    document.getElementById('so-vb-ct').focus();
                    return;
                }
                if (!globalDocumentData.NgayCT) {
                    alert('Vui lòng chọn Ngày VB chấp thuận trước khi xuất file Word!');
                    document.getElementById('ngay-ct').focus();
                    return;
                }

                document.getElementById('loading-message').classList.remove('hidden');
                document.getElementById('loading-message').textContent = 'Đang xuất file Word...';

                const templateUrl = 'https://poalninh.github.io/templates/Baocao_cucDBNV_BoSungTuyen.docx';

                const response = await fetch(templateUrl);
                if (!response.ok) throw new Error('Không thể tải template Word');

                const templateContent = await response.arrayBuffer();
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                const exportData = { ...globalDocumentData };

                doc.setData(exportData);
                doc.render();

                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `Baocao_CucDBVN_BoSungTuyen_${globalDocumentData.RefBendi || ''}_${globalDocumentData.RefBenden || ''}.docx`;
                saveAs(blob, fileName);

                hideLoadingMessage();

            } catch (error) {
                console.error('Lỗi xuất file Word:', error);
                alert('Có lỗi xảy ra khi xuất file Word: ' + error.message);
                hideLoadingMessage();
            }
        }

        // Initialize application
        async function initialize() {
            try {
                const idTB = getIDFromURL();
                if (!idTB) {
                    alert('Vui lòng cung cấp ID_TB trong URL. Ví dụ: ?ID_TB=TB001');
                    hideLoadingMessage();
                    return;
                }
                await loadData();
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Không thể kết nối với hệ thống. Vui lòng thử lại sau.');
                hideLoadingMessage();
            }
        }

        // Initialize event listeners (giống cách bạn làm)
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('so-vb-dx').addEventListener('input', updateFromInputs);
            document.getElementById('ngay-dx').addEventListener('change', updateFromInputs);
            document.getElementById('so-vb-ct').addEventListener('input', updateFromInputs);
            document.getElementById('ngay-ct').addEventListener('change', updateFromInputs);

            setTimeout(() => {
                initialize();
            }, 500);
        });

        // Disable right-click and F12 (giữ y code của bạn)
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        };
    </script>
</body>

</html>
