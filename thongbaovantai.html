<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Báo</title>
    <!-- Thêm các thư viện cần thiết -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <style>
        @page {
            size: A4;
            margin: 1.5cm 1.5cm 1.5cm 2.5cm;
        }

        @page landscape {
            size: A4 landscape;
            margin: 1cm 1.5cm 1cm 2cm;
        }

        body {
            font-family: 'Times New Roman', serif;
            font-size: 14pt;
            line-height: 1.3;
            margin: 0;
            padding: 0;
        }

        .page {
            box-sizing: border-box;
            padding: 0;
            position: relative;
            width: 21cm;
            height: 29.7cm;
            margin: 0 auto;
            background-color: white;
        }

        .landscape-page {
            width: 31.7cm;
            min-height: 21cm;
            height: auto;
            page: landscape;
            page-break-before: always;
            page-break-after: auto;
        }

        .landscape-container {
            width: 100%;
            height: auto;
            padding: 1cm;
        }

        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0;
            align-items: flex-start;
        }

        .header-left {
            text-align: center;
            width: 40%;
        }

        .header-right {
            text-align: center;
            width: 60%;
            font-weight: bold;
        }

        .document-number {
            margin-top: 10px;
        }

        .title {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            position: relative;
            font-weight: bold;
        }

        .title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 30%;
            height: 1.5px;
            background-color: black;
        }

        .underline-title,
        .underline-title-full {
            display: inline-block;
            position: relative;
            font-weight: bold;
        }

        .underline-title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 50%;
            height: 1.5px;
            background-color: black;
        }

        .underline-title-full::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 100%;
            height: 1.5px;
            background-color: black;
        }

        .italic-text {
            font-style: italic;
            text-align: justify;
            margin: 10px 0;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .footer-left {
            width: 60%;
        }

        .footer-right {
            width: 40%;
            text-align: center;
        }

        .signature-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .signature-name {
            font-weight: bold;
            margin-top: 100px;
        }

        .recipient-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 5px;
        }

        .recipient-item {
            margin: 1px 0;
        }

        .control-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .month-selector label {
            font-weight: bold;
            color: #333;
        }

        .month-selector select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .month-selector select:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .control-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .load-button {
            background-color: #2196F3;
            color: white;
        }

        .load-button:hover {
            background-color: #1976D2;
        }

        .print-button {
            background-color: #4CAF50;
            color: white;
        }

        .print-button:hover {
            background-color: #45a049;
        }

        .export-button {
            background-color: #FF9800;
            color: white;
        }

        .export-button:hover {
            background-color: #F57C00;
        }

        .document-content {
            margin-top: 100px;
        }

        @media print {
            .control-panel {
                display: none !important;
            }

            .document-content {
                margin-top: 0;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .page {
                margin: 0;
                padding: 0;
                border: none;
            }

            .page-break {
                display: none !important;
            }

            .landscape-page {
                height: auto !important;
                min-height: 21cm;
                page-break-before: always;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tr {
                page-break-inside: avoid;
            }

            table {
                page-break-inside: auto;
            }
        }

        .text-block {
            text-align: justify;
            text-indent: 30px;
        }

        .table-container {
            width: 100%;
            margin: 20px auto;
            height: auto;
        }

        .table-title {
            text-align: center;
            font-weight: bold;
            font-size: 16pt;
            margin-bottom: 20px;
        }

        .group-header {
            background-color: #f0f0f0;
            font-weight: bold;
            font-size: 14pt;
            padding: 8px;
            text-align: left;
            border: 1px solid black;
        }

        .sub-header {
            background-color: #f8f8f8;
            font-weight: bold;
            font-style: italic;
            padding: 5px 8px;
            text-align: left;
            border: 1px solid black;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid black;
            page-break-inside: auto;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            font-size: 12pt;
        }

        th {
            font-weight: bold;
            background-color: #f2f2f2;
        }

        thead {
            display: table-header-group;
        }

        tbody {
            display: table-row-group;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        .text-left {
            text-align: left;
        }

        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
        }

        .hidden {
            display: none;
        }

        .location-group {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }

        /* Thêm style cho thống kê */
        /* .statistics-section {
            margin: 20px 0;
            color: red;
            font-weight: bold;
        } */

        .stat-item {
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <!-- Control Panel -->
    <div class="control-panel">
        <div class="month-selector">
            <label for="month-select">Chọn tháng:</label>
            <select id="month-select">
                <option value="1">Tháng 1</option>
                <option value="2">Tháng 2</option>
                <option value="3">Tháng 3</option>
                <option value="4">Tháng 4</option>
                <option value="5">Tháng 5</option>
                <option value="6">Tháng 6</option>
                <option value="7">Tháng 7</option>
                <option value="8">Tháng 8</option>
                <option value="9">Tháng 9</option>
                <option value="10">Tháng 10</option>
                <option value="11">Tháng 11</option>
                <option value="12">Tháng 12</option>
            </select>

            <label for="year-select">Năm:</label>
            <select id="year-select">
                <!-- Years will be populated dynamically -->
            </select>
        </div>

        <div class="action-buttons">
            <button class="control-button load-button" onclick="loadDataForSelectedMonth()">Tải Dữ Liệu</button>
            <button class="control-button print-button" onclick="window.print()">In Tài Liệu</button>
            <button class="control-button export-button" onclick="exportToWordTemplate()">Xuất Word</button>
        </div>
    </div>

    <!-- Loading Message -->
    <div id="loading-message">Đang tải dữ liệu...</div>

    <div class="document-content">
        <!-- First page in portrait orientation -->
        <div class="page">
            <div class="document-container">
                <div class="header">
                    <div class="header-left">
                        <div style="margin-bottom: 5px;">UBND TỈNH BẮC GIANG</div>
                        <div class="underline-title"><strong>SỞ XÂY DỰNG</strong></div>
                        <div class="document-number">Số: <span>______</span>/TB-SXD</div>
                    </div>
                    <div class="header-right">
                        <div style="margin-bottom: 5px;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
                        <div class="underline-title-full"><span class="underline-text">Độc lập – Tự do – Hạnh
                                phúc</span>
                        </div>
                        <div style="font-style: italic; font-weight: normal; margin-top: 10px; text-align: center;"
                            id="ngay-thang">Bắc
                            Giang, ngày &nbsp;&nbsp;&nbsp; tháng &nbsp;&nbsp;&nbsp; <span>năm 2025</span>
                        </div>
                    </div>
                </div>

                <div class="title">
                    THÔNG BÁO<br>
                    <span id="title-thang">Danh sách phương tiện, loại phù hiệu đã cấp, thời hạn có hiệu lực của phù
                        hiệu và
                        đơn vị kinh doanh vận tải đã được cấp giấy phép kinh doanh vận tải bằng xe ô tô; danh sách
                        phương
                        tiện bị thu hồi, bị tước phù hiệu; danh sách đơn vị kinh doanh vận tải bị thu hồi, bị tước giấy
                        phép
                        kinh doanh vận tải bằng xe ô tô trong <span id="thang-thong-bao">tháng</span></span>
                </div>

                <div class="text-block">
                    Căn cứ điểm b khoản 8 Điều 21 Nghị định số 158/2024/NĐ-CP ngày 18/12/2024 của Chính phủ Quy định về
                    hoạt
                    động vận tải đường bộ.
                </div>

                <div class="text-block">
                    Để phục vụ công tác kiểm tra, giám sát của các cơ quan chức năng và chính quyền địa phương trong
                    hoạt động kinh doanh vận tải bằng xe ô tô, Sở Xây dựng tỉnh Bắc Giang thông báo danh sách phương
                    tiện, loại phù hiệu đã cấp, thời hạn có hiệu lực của phù hiệu và đơn vị kinh doanh vận tải đã được
                    cấp giấy phép kinh doanh vận tải bằng xe ô tô; danh sách phương tiện bị thu hồi, bị tước phù hiệu;
                    danh sách đơn vị kinh doanh vận tải bị thu hồi, bị tước giấy phép kinh doanh vận tải bằng xe ô tô
                    trong <span id="thang-thong-bao-2">tháng</span>, cụ thể như sau:
                </div>

                <!-- Thêm phần thống kê -->
                <div class="text-block" id="statistics-content">
                    <div class="stat-item">- Phương tiện được cấp phù hiệu: <span id="stat-phu-hieu">0</span> xe;</div>
                    <div class="stat-item">- Đơn vị được cấp giấy phép kinh doanh vận tải: <span id="stat-gpkd">0</span>
                        đơn vị;</div>
                    <div class="stat-item">- Phương tiện thu hồi, tước phù hiệu: <span
                            id="stat-phu-hieu-thu-hoi">0</span> xe;</div>
                    <div class="stat-item">- Đơn vị kinh doanh vận tải bị thu hồi, bị tước giấy phép kinh doanh vận tải
                        bằng xe ô tô: <span id="stat-gpkd-thu-hoi">0</span> đơn vị.</div>
                </div>

                <div class="text-block" style="font-style: italic; margin-top: 8px; margin-left: 200px;">
                    (Chi tiết theo phụ lục đính kèm)
                </div>

                <div class="text-block">
                    Sở Xây dựng tỉnh Bắc Giang trân trọng thông báo./.
                </div>

                <div class="footer">
                    <div class="footer-left">
                        <div><strong>Nơi nhận:</strong></div>
                        <div class="recipient-item">- Công an tỉnh;</div>
                        <div class="recipient-item">- UBND các huyện, thị xã, TP;</div>
                        <div class="recipient-item">- UBND các xã, phường, thị trấn &nbsp; (p/h)</div>
                        <div class="recipient-item">nơi đơn vị vận tải đặt trụ sở; </div>
                        <div class="recipient-item">- Giám đốc Sở (b/c);</div>
                        <div class="recipient-item">- Các đơn vị vận tải;</div>
                        <div class="recipient-item">- Các bến xe khách;</div>
                        <div class="recipient-item">- Văn phòng Sở (đăng Websites);</div>
                        <div class="recipient-item">- Thanh tra Sở;</div>
                        <div class="recipient-item">- Lưu: VT, VTATGT.</div>
                    </div>
                    <div class="footer-right">
                        <div class="signature-title">KT. GIÁM ĐỐC</div>
                        <div class="signature-title">PHÓ GIÁM ĐỐC</div>
                        <div style="margin-top: 195px;"></div>
                        <div class="signature-name">Hoàng Văn Hải</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined page for all appendixes -->
        <div class="page landscape-page">
            <div class="landscape-container">
                <div class="table-container">
                    <div class="table-title">
                        DANH SÁCH ĐƠN VỊ, PHƯƠNG TIỆN VẬN TẢI
                    </div>
                    <div id="combined-tables">
                        <!-- All grouped tables will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = 'd22767b5-f711-42f8-bbbd-4cf04b26ef3d';
        const accessKey = 'V2-Qcjpo-7Ybu9-g87XI-TFLes-kJGWn-btYR5-cLMmk-FjrRj';
        const region = 'www';

        // Biến toàn cục để lưu thống kê
        let globalStats = {
            phuHieu: 0,
            gpkd: 0,
            phuHieuThuHoi: 0,
            gpkdThuHoi: 0
        };

        // Function to populate year selector
        function populateYearSelector() {
            const yearSelect = document.getElementById('year-select');
            const currentYear = new Date().getFullYear();

            for (let year = 2020; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        function setDefaultMonthYear() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            document.getElementById('month-select').value = currentMonth;
        }

        function getSelectedMonthYear() {
            const month = parseInt(document.getElementById('month-select').value);
            const year = parseInt(document.getElementById('year-select').value);
            return { month, year };
        }

        function loadDataForSelectedMonth() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');

            if (!monthSelect || !yearSelect) {
                console.error('Không tìm thấy dropdown tháng/năm');
                return;
            }

            const month = parseInt(monthSelect.value);
            const year = parseInt(yearSelect.value);

            if (isNaN(month) || isNaN(year)) {
                console.error('Tháng hoặc năm không hợp lệ');
                alert('Vui lòng chọn tháng và năm hợp lệ');
                return;
            }

            console.log(`Loading data for ${month}/${year}`);
            fetchData(month, year);
        }

        function formatDateForFilter(month, year) {
            const startDate = `${year}-${month.toString().padStart(2, '0')}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month.toString().padStart(2, '0')}-${lastDay}`;
            return { startDate, endDate };
        }

        // Function to fetch all THONGTINDONVIVANTAI data for lookup
        async function fetchAllCompanyData() {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/THONGTINDONVIVANTAI/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {
                            Selector: 'SELECT(THONGTINDONVIVANTAI[IDDoanhNghiep], TRUE)'
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                const companyLookup = {};
                result.forEach(company => {
                    if (company.IDDoanhNghiep) {
                        companyLookup[company.IDDoanhNghiep] = {
                            tenDoanh: company.TenDoanhNghiep || '',
                            diaChi: company.SoNha_TDP || '',
                            xaPhuongThiTran: company.XaPhuongThiTran || '',
                            quanHuyen: company.QuanHuyen || ''
                        };
                    }
                });

                return companyLookup;
            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu công ty:', error);
                return {};
            }
        }

        async function fetchTableDataWithFilter(tableName, idField, dateField, month, year) {
            try {
                const { startDate, endDate } = formatDateForFilter(month, year);

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {
                            Selector: `SELECT(${tableName}[${idField}], AND([${dateField}] >= DATE("${startDate}"), [${dateField}] <= DATE("${endDate}")))`
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log(`Dữ liệu từ bảng ${tableName}:`, result);
                return result;
            } catch (error) {
                console.error(`Lỗi khi lấy dữ liệu từ bảng ${tableName}:`, error);
                return [];
            }
        }

        // Function to group data by XaPhuongThiTran
        function groupDataByLocation(data, companyLookup) {
            const grouped = {};

            data.forEach(item => {
                let xaPhuong = '';
                let quanHuyen = '';
                let companyInfo = null;

                // Try different ID fields to match with company lookup
                const possibleIds = [item.Ref_DonViCapPhuHieu, item.Ref_DoanhNghiep, item.RefDonVi, item.IDDoanhNghiep];

                for (const id of possibleIds) {
                    if (id && companyLookup[id]) {
                        companyInfo = companyLookup[id];
                        xaPhuong = companyInfo.xaPhuongThiTran;
                        quanHuyen = companyInfo.quanHuyen;
                        break;
                    }
                }

                if (!xaPhuong) {
                    xaPhuong = 'Không xác định';
                    quanHuyen = 'Không xác định';
                }

                const locationKey = `${xaPhuong}, ${quanHuyen}`;

                if (!grouped[locationKey]) {
                    grouped[locationKey] = [];
                }

                // Add company info to item
                if (companyInfo) {
                    item.tenDoanhNghiep = companyInfo.tenDoanh;
                    item.diaChiDoanhNghiep = companyInfo.diaChi;
                }

                grouped[locationKey].push(item);
            });

            return grouped;
        }

        // Function to calculate statistics
        function calculateStatistics(phuHieuData, gpkdData, phuHieuThuHoiData, gpkdThuHoiData) {
            globalStats = {
                phuHieu: phuHieuData ? phuHieuData.length : 0,
                gpkd: gpkdData ? gpkdData.length : 0,
                phuHieuThuHoi: phuHieuThuHoiData ? phuHieuThuHoiData.length : 0,
                gpkdThuHoi: gpkdThuHoiData ? gpkdThuHoiData.length : 0
            };

            // Update statistics display
            updateStatisticsDisplay();
        }

        // Function to update statistics display
        function updateStatisticsDisplay() {
            document.getElementById('stat-phu-hieu').textContent = globalStats.phuHieu;
            document.getElementById('stat-gpkd').textContent = globalStats.gpkd;
            document.getElementById('stat-phu-hieu-thu-hoi').textContent = globalStats.phuHieuThuHoi;
            document.getElementById('stat-gpkd-thu-hoi').textContent = globalStats.gpkdThuHoi;
        }

        // Function to create table for specific data type
        function createTableByType(data, tableType, subIndex) {
            if (!data || data.length === 0) {
                return '';
            }

            let headerHtml = '';
            let subHeaderText = '';

            switch (tableType) {
                case 'phuHieu':
                    subHeaderText = '- Danh sách các phương tiện được cấp phù hiệu vận tải';
                    headerHtml = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 4%;">STT</th>
                            <th style="width: 8%;">Biển kiểm soát</th>
                            <th style="width: 7%;">Số ghế</th>
                            <th style="width: 7%;">Tải trọng</th>
                            <th style="width: 10%;">Số phù hiệu</th>
                            <th style="width: 9%;">Loại phù hiệu</th>
                            <th style="width: 9%;">Có giá trị đến</th>
                            <th style="width: 10%;">Tuyến khai thác</th>
                            <th style="width: 10%;">Tuyến buýt</th>
                            <th style="width: 15%;">Tên đơn vị vận tải</th>
                            <th style="width: 14%;">Địa chỉ chi tiết</th>
                        </tr>
                    </thead>
                    <tbody>`;
                    break;
                case 'gpkd':
                    subHeaderText = '- Danh sách các đơn vị được cấp giấy phép kinh doanh vận tải bằng xe ô tô';
                    headerHtml = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 4%;">STT</th>
                            <th style="width: 20%;">Tên đơn vị vận tải</th>
                            <th style="width: 24%;">Địa chỉ chi tiết</th>
                            <th style="width: 10%;">Số ĐKKD</th>
                            <th style="width: 14%;">Số GP</th>
                            <th style="width: 10%;">Ngày cấp</th>
                            <th style="width: 18%;">Loại hình được cấp</th>
                        </tr>
                    </thead>
                    <tbody>`;
                    break;
                case 'phuHieuThuHoi':
                    subHeaderText = '- Danh sách các phương tiện bị thu hồi phù hiệu vận tải';
                    headerHtml = `
                    <table>
                   <thead>
                       <tr>
                           <th style="width: 4%;">STT</th>
                           <th style="width: 10%;">Biển số</th>
                           <th style="width: 10%;">Số Phù hiệu</th>
                           <th style="width: 10%;">Loại PH</th>
                           <th style="width: 10%;">Hạn Phù hiệu</th>
                           <th style="width: 10%;">Tuyến cố định</th>
                           <th style="width: 10%;">Tuyến buýt</th>
                           <th style="width: 15%;">Tên đơn vị vận tải</th>
                           <th style="width: 15%;">Địa chỉ chi tiết</th>
                          <th style="width: 12%;">Chỉ chú</th>
                      </tr>
                  </thead>
                  <tbody>`;
                    break;
                case 'gpkdThuHoi':
                    subHeaderText = '- Danh sách các đơn vị bị thu hồi giấy phép kinh doanh vận tải bằng xe ô tô';
                    headerHtml = `
              <table>
                      <thead>
                          <tr>
                              <th style="width: 4%;">STT</th>
                              <th style="width: 15%;">Tên đơn vị vận tải</th>
                              <th style="width: 24%;">Địa chỉ chi tiết</th>
                              <th style="width: 10%;">Số ĐKKD</th>
                              <th style="width: 12%;">Số GP KDVT</th>
                              <th style="width: 10%;">Ngày cấp</th>
                              <th style="width: 18%;">Loại hình KDVT đã được cấp</th>
                          </tr>
                      </thead>
                      <tbody>`;
                    break;
            }

            let html = `<div class="sub-header">${subHeaderText}</div>`;
            html += headerHtml;

            data.forEach((item, index) => {
                let rowHtml = '';

                switch (tableType) {
                    case 'phuHieu':
                        rowHtml = `
                  <tr>
                      <td>${index + 1}</td>
                      <td>${item.BienSo || ''}</td>
                      <td>${item['Số ghế'] || ''}</td>
                      <td>${item['Tải trọng'] || ''}</td>
                      <td>${item.SoPhuHieu || ''}</td>
                      <td>${item.LoaiPH || ''}</td>
                      <td>${formatDate(item.NgayHetHan)}</td>
                      <td class="text-left">${item['Tuyến khai thác'] || ''}</td>
                      <td class="text-left">${item['Tuyến buýt'] || ''}</td>
                      <td class="text-left">${item.tenDoanhNghiep || ''}</td>
                      <td class="text-left">${item.diaChiDoanhNghiep || ''}</td>
                </tr>`;
                        break;
                    case 'gpkd':
                        rowHtml = `
                <tr>
                    <td>${index + 1}</td>
                    <td class="text-left">${item.tenDoanhNghiep || ''}</td>
                    <td class="text-left">${item.diaChiDoanhNghiep || ''}</td>
                    <td>${item.SoDKKD || ''}</td>
                    <td>${item.SoGiayPhep || ''}</td>
                    <td>${formatDate(item.NgayCap)}</td>
                    <td>${item.LoaiHinhVanTai || ''}</td>
                </tr>`;
                        break;
                    case 'phuHieuThuHoi':
                        rowHtml = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item['Biển số'] || ''}</td>
                    <td>${item['Số Phù hiệu'] || ''}</td>
                    <td>${item['Loại Phù hiệu'] || ''}</td>
                    <td>${formatDate(item['Ngày hết hạn phù hiệu'])}</td>
                    <td class="text-left">${item['Tuyến khai thác'] || ''}</td>
                    <td class="text-left">${item['Tuyến buýt'] || ''}</td>
                    <td class="text-left">${item.tenDoanhNghiep || ''}</td>
                    <td class="text-left">${item.diaChiDoanhNghiep || ''}</td>
                    <td class="text-left">${item['Văn bản ngừng'] || ''}</td>
                </tr>`;
                        break;
                    case 'gpkdThuHoi':
                        rowHtml = `
                <tr>
                    <td>${index + 1}</td>
                    <td class="text-left">${item.tenDoanhNghiep || ''}</td>
                    <td class="text-left">${item.diaChiDoanhNghiep || ''}</td>
                    <td>${item['Số ĐKKD'] || ''}</td>
                    <td>${item['Số GP KDVT'] || ''}</td>
                    <td>${formatDate(item['Ngày cấp'])}</td>
                    <td>${item['Loại hình vận tải'] || ''}</td>
                </tr>`;
                        break;
                }

                html += rowHtml;
            });

            html += '</tbody></table>';
            return html;
        }

        // Function to create combined grouped table
        function createCombinedGroupedTable(groupedData1, groupedData2, groupedData3, groupedData4) {
            let html = '';
            let locationIndex = 1;

            // Get all unique locations from all datasets
            const allLocations = new Set([
                ...Object.keys(groupedData1),
                ...Object.keys(groupedData2),
                ...Object.keys(groupedData3),
                ...Object.keys(groupedData4)
            ]);

            // Sort locations alphabetically
            const sortedLocations = Array.from(allLocations).sort();

            for (const location of sortedLocations) {
                // Check if this location has any data
                const hasData1 = groupedData1[location] && groupedData1[location].length > 0;
                const hasData2 = groupedData2[location] && groupedData2[location].length > 0;
                const hasData3 = groupedData3[location] && groupedData3[location].length > 0;
                const hasData4 = groupedData4[location] && groupedData4[location].length > 0;

                if (!hasData1 && !hasData2 && !hasData3 && !hasData4) {
                    continue;
                }

                html += `<div class="location-group">`;
                html += `<div class="group-header">${locationIndex}. ${location}</div>`;

                // Add each section if it has data
                if (hasData1) {
                    html += createTableByType(groupedData1[location], 'phuHieu', locationIndex);
                }

                if (hasData2) {
                    html += createTableByType(groupedData2[location], 'gpkd', locationIndex);
                }

                if (hasData3) {
                    html += createTableByType(groupedData3[location], 'phuHieuThuHoi', locationIndex);
                }

                if (hasData4) {
                    html += createTableByType(groupedData4[location], 'gpkdThuHoi', locationIndex);
                }

                html += `</div>`;
                locationIndex++;
            }

            return html;
        }

        // Main function to fetch data
        async function fetchData(selectedMonth = null, selectedYear = null) {
            try {
                // Show loading message
                document.getElementById('loading-message').classList.remove('hidden');

                // Get month and year
                let month, year;
                if (selectedMonth !== null && selectedYear !== null &&
                    !isNaN(selectedMonth) && !isNaN(selectedYear)) {
                    month = selectedMonth;
                    year = selectedYear;
                } else {
                    const monthSelect = document.getElementById('month-select');
                    const yearSelect = document.getElementById('year-select');

                    if (monthSelect && yearSelect && monthSelect.value && yearSelect.value) {
                        month = parseInt(monthSelect.value);
                        year = parseInt(yearSelect.value);
                    } else {
                        const today = new Date();
                        month = today.getMonth() + 1;
                        year = today.getFullYear();
                    }
                }

                console.log(`Fetching data for month: ${month}, year: ${year}`);

                // Update page 1 content with selected month
                updatePage1Content(month, year);

                // First fetch company lookup data
                const companyLookup = await fetchAllCompanyData();

                // Fetch data from all tables with date filtering
                const [phuHieuData, gpkdData, phuHieuThuHoiData, gpkdThuHoiData] = await Promise.all([
                    fetchTableDataWithFilter('PHUHIEUXE', 'ID_PhuHieu', 'NgayCap', month, year),
                    fetchTableDataWithFilter('GIAYPHEPKINHDOANHNOIDIA', 'ID_GPKD', 'NgayCap', month, year),
                    fetchTableDataWithFilter('PHUHIEU_THUHOI_CHITIET', 'ID_Row', 'Ngày hết hạn phù hiệu', month, year),
                    fetchTableDataWithFilter('GPKD_THUHOI_CHITIET', 'ID_Row', 'Ngày thu hồi', month, year)
                ]);

                // Calculate and update statistics
                calculateStatistics(phuHieuData, gpkdData, phuHieuThuHoiData, gpkdThuHoiData);

                // Group data by location
                const groupedPhuHieu = groupDataByLocation(phuHieuData || [], companyLookup);
                const groupedGpkd = groupDataByLocation(gpkdData || [], companyLookup);
                const groupedPhuHieuThuHoi = groupDataByLocation(phuHieuThuHoiData || [], companyLookup);
                const groupedGpkdThuHoi = groupDataByLocation(gpkdThuHoiData || [], companyLookup);

                // Create combined table
                const combinedHtml = createCombinedGroupedTable(
                    groupedPhuHieu,
                    groupedGpkd,
                    groupedPhuHieuThuHoi,
                    groupedGpkdThuHoi
                );

                // Populate combined table
                const combinedContainer = document.getElementById('combined-tables');
                if (combinedContainer) {
                    if (combinedHtml) {
                        combinedContainer.innerHTML = combinedHtml;
                    } else {
                        combinedContainer.innerHTML = '<p style="text-align: center; font-style: italic;">Không có dữ liệu</p>';
                    }
                }

                // Hide loading message
                hideLoadingMessage();

            } catch (error) {
                console.error('Lỗi:', error);
                hideLoadingMessage();
                alert('Đã xảy ra lỗi khi lấy dữ liệu: ' + error.message);
            }
        }

        // Format dates as dd/mm/yyyy
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = date.getMonth() + 1;
            const formattedMonth = month <= 2 ?
                month.toString().padStart(2, '0') :
                month.toString();
            return `${day}/${formattedMonth}/${date.getFullYear()}`;
        }

        // Function to update page 1 content
        function updatePage1Content(month, year) {
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const currentMonth = today.getMonth() + 1;
            const formattedCurrentMonth = currentMonth <= 2 ?
                currentMonth.toString().padStart(2, '0') :
                currentMonth.toString();

            const formattedMonth = month <= 2 ?
                month.toString().padStart(2, '0') :
                month.toString();

            // Update date
            document.getElementById('ngay-thang').textContent =
                `Bắc Giang, ngày ${day} tháng ${formattedCurrentMonth} năm ${year}`;

            // Update titles with selected month
            const monthYearText = `${formattedMonth}/${year}`;

            const thangThongBao1 = document.getElementById('thang-thong-bao');
            if (thangThongBao1) {
                thangThongBao1.textContent = `tháng ${monthYearText}`;
            }

            const thangThongBao2 = document.getElementById('thang-thong-bao-2');
            if (thangThongBao2) {
                thangThongBao2.textContent = `tháng ${monthYearText}`;
            }
        }

        // Hide loading message
        function hideLoadingMessage() {
            document.getElementById('loading-message').classList.add('hidden');
        }

        // Function to export to Word
        async function exportToWordTemplate() {
            try {
                document.getElementById('loading-message').classList.remove('hidden');

                // Get selected month info
                let month, year;
                const monthSelect = document.getElementById('month-select');
                const yearSelect = document.getElementById('year-select');

                if (monthSelect && yearSelect && monthSelect.value && yearSelect.value) {
                    month = parseInt(monthSelect.value);
                    year = parseInt(yearSelect.value);
                } else {
                    const today = new Date();
                    month = today.getMonth() + 1;
                    year = today.getFullYear();
                }

                if (isNaN(month) || isNaN(year)) {
                    throw new Error('Tháng hoặc năm không hợp lệ');
                }

                console.log(`Exporting Word for month: ${month}, year: ${year}`);

                const today = new Date();

                // Fetch company lookup data first
                const companyLookup = await fetchAllCompanyData();

                // Fetch data from all tables
                const [phuHieuData, gpkdData, phuHieuThuHoiData, gpkdThuHoiData] = await Promise.all([
                    fetchTableDataWithFilter('PHUHIEUXE', 'ID_PhuHieu', 'NgayCap', month, year),
                    fetchTableDataWithFilter('GIAYPHEPKINHDOANHNOIDIA', 'ID_GPKD', 'NgayCap', month, year),
                    fetchTableDataWithFilter('PHUHIEU_THUHOI_CHITIET', 'ID_Row', 'Ngày hết hạn phù hiệu', month, year),
                    fetchTableDataWithFilter('GPKD_THUHOI_CHITIET', 'ID_Row', 'Ngày thu hồi', month, year)
                ]);

                // Group data by location
                const groupedPhuHieu = groupDataByLocation(phuHieuData || [], companyLookup);
                const groupedGpkd = groupDataByLocation(gpkdData || [], companyLookup);
                const groupedPhuHieuThuHoi = groupDataByLocation(phuHieuThuHoiData || [], companyLookup);
                const groupedGpkdThuHoi = groupDataByLocation(gpkdThuHoiData || [], companyLookup);

                // Prepare grouped data for Word template
                const prepareGroupedDataForWord = () => {
                    const result = [];

                    // Get all unique locations
                    const allLocations = new Set([
                        ...Object.keys(groupedPhuHieu),
                        ...Object.keys(groupedGpkd),
                        ...Object.keys(groupedPhuHieuThuHoi),
                        ...Object.keys(groupedGpkdThuHoi)
                    ]);

                    const sortedLocations = Array.from(allLocations).sort();
                    let locationIndex = 1;

                    for (const location of sortedLocations) {
                        const locationData = {
                            locationIndex: locationIndex,
                            locationName: location,
                            phuHieuGrouped: [],
                            gpkdGrouped: [],
                            phuHieuThuHoiGrouped: [],
                            gpkdThuHoiGrouped: [],
                            hasPhuHieu: false,
                            hasGpkd: false,
                            hasPhuHieuThuHoi: false,
                            hasGpkdThuHoi: false
                        };

                        // Prepare phù hiệu data
                        if (groupedPhuHieu[location] && groupedPhuHieu[location].length > 0) {
                            locationData.hasPhuHieu = true;
                            locationData.phuHieuGrouped = groupedPhuHieu[location].map((item, index) => ({
                                stt: (index + 1).toString(),
                                bien_so: item.BienSo || '',
                                so_ghe: item['Số ghế'] || '',
                                tai_trong: item['Tải trọng'] || '',
                                so_phu_hieu: item.SoPhuHieu || '',
                                loai_phu_hieu: item.LoaiPH || '',
                                co_gia_tri_den: formatDate(item.NgayHetHan),
                                tuyen_khai_thac: item['Tuyến khai thác'] || '',
                                tuyen_buyt: item['Tuyến buýt'] || '',
                                ten_don_vi: item.tenDoanhNghiep || '',
                                dia_chi: item.diaChiDoanhNghiep || ''
                            }));
                        }

                        // Prepare GPKD data
                        if (groupedGpkd[location] && groupedGpkd[location].length > 0) {
                            locationData.hasGpkd = true;
                            locationData.gpkdGrouped = groupedGpkd[location].map((item, index) => ({
                                stt: (index + 1).toString(),
                                ten_don_vi: item.tenDoanhNghiep || '',
                                dia_chi: item.diaChiDoanhNghiep || '',
                                so_dkkd: item.SoDKKD || '',
                                so_gp: item.SoGiayPhep || '',
                                ngay_cap: formatDate(item.NgayCap),
                                loai_hinh: item.LoaiHinhVanTai || ''
                            }));
                        }

                        // Prepare phù hiệu thu hồi data
                        if (groupedPhuHieuThuHoi[location] && groupedPhuHieuThuHoi[location].length > 0) {
                            locationData.hasPhuHieuThuHoi = true;
                            locationData.phuHieuThuHoiGrouped = groupedPhuHieuThuHoi[location].map((item, index) => ({
                                stt: (index + 1).toString(),
                                bien_so: item['Biển số'] || '',
                                so_phu_hieu: item['Số Phù hiệu'] || '',
                                loai_ph: item['Loại Phù hiệu'] || '',
                                han_phu_hieu: formatDate(item['Ngày hết hạn phù hiệu']),
                                tuyen_khai_thac: item['Tuyến khai thác'] || '',
                                tuyen_buyt: item['Tuyến buýt'] || '',
                                ten_don_vi: item.tenDoanhNghiep || '',
                                dia_chi: item.diaChiDoanhNghiep || '',
                                van_ban_ngung: item['Văn bản ngừng'] || ''
                            }));
                        }

                        // Prepare GPKD thu hồi data
                        if (groupedGpkdThuHoi[location] && groupedGpkdThuHoi[location].length > 0) {
                            locationData.hasGpkdThuHoi = true;
                            locationData.gpkdThuHoiGrouped = groupedGpkdThuHoi[location].map((item, index) => ({
                                stt: (index + 1).toString(),
                                ten_don_vi: item.tenDoanhNghiep || '',
                                dia_chi: item.diaChiDoanhNghiep || '',
                                so_dkkd: item['Số ĐKKD'] || '',
                                so_gp_kdvt: item['Số GP KDVT'] || '',
                                ngay_cap: formatDate(item['Ngày cấp']),
                                loai_hinh_kdvt: item['Loại hình vận tải'] || ''
                            }));
                        }

                        // Only add location if it has data
                        if (locationData.hasPhuHieu || locationData.hasGpkd ||
                            locationData.hasPhuHieuThuHoi || locationData.hasGpkdThuHoi) {
                            result.push(locationData);
                            locationIndex++;
                        }
                    }

                    return result;
                };

                const response = await fetch('templates/Thong_bao_van_tai.docx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }
                const templateContent = await response.arrayBuffer();

                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                // Process date formatting
                const ngayKy = today.getDate().toString().padStart(2, '0');
                const thangKy = today.getMonth() + 1;
                const formattedThangKy = thangKy <= 2 ?
                    thangKy.toString().padStart(2, '0') :
                    thangKy.toString();

                const thang_thong_bao = month <= 2 ?
                    month.toString().padStart(2, '0') :
                    month.toString();

                // Set data for template
                const data = {
                    ngayKy: ngayKy,
                    thangKy: formattedThangKy,
                    nam: today.getFullYear(),
                    thang_thong_bao: thang_thong_bao,
                    nam_thong_bao: year,
                    locations: prepareGroupedDataForWord(),
                    totalLocations: prepareGroupedDataForWord().length,
                    // Thêm thống kê vào data cho Word template
                    stat_phu_hieu: globalStats.phuHieu,
                    stat_gpkd: globalStats.gpkd,
                    stat_phu_hieu_thu_hoi: globalStats.phuHieuThuHoi,
                    stat_gpkd_thu_hoi: globalStats.gpkdThuHoi
                };

                console.log('Word template data:', data);

                // Render template
                doc.setData(data);
                doc.render();

                // Generate and download file
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `Thong_bao_van_tai_${thang_thong_bao}_${year}.docx`;
                saveAs(blob, fileName);

                console.log(`Word file exported: ${fileName}`);

            } catch (error) {
                console.error('Lỗi khi xuất file Word:', error);
                if (error.properties && error.properties.errors) {
                    console.log('Template Error details:', error.properties.errors);
                }
                alert('Có lỗi khi xuất file Word: ' + error.message);
            } finally {
                document.getElementById('loading-message').classList.add('hidden');
            }
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            populateYearSelector();
            setDefaultMonthYear();
            const { month, year } = getSelectedMonthYear();
            fetchData(month, year);
        });

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>