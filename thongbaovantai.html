<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Báo</title>
    <!-- Thêm các thư viện cần thiết -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <style>
        @page {
            size: A4;
            margin: 1.5cm 1.5cm 1.5cm 2.5cm;
        }

        @page landscape {
            size: A4 landscape;
            margin: 1cm 1.5cm 1cm 2cm;
        }

        body {
            font-family: 'Times New Roman', serif;
            font-size: 14pt;
            line-height: 1.3;
            margin: 0;
            padding: 0;
        }

        .page {
            box-sizing: border-box;
            padding: 0;
            position: relative;
            width: 21cm;
            height: 29.7cm;
            margin: 0 auto;
            background-color: white;
        }

        .landscape-page {
            width: 31.7cm;
            min-height: 21cm;
            height: auto;
            page: landscape;
            page-break-before: always;
            page-break-after: auto;
        }

        .landscape-container {
            width: 100%;
            height: auto;
            padding: 1cm;
        }

        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0;
            align-items: flex-start;
        }

        .header-left {
            text-align: center;
            width: 40%;
        }

        .header-right {
            text-align: center;
            width: 60%;
            font-weight: bold;
        }

        .document-number {
            margin-top: 10px;
        }

        .title {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            position: relative;
            font-weight: bold;
        }

        .title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 30%;
            height: 1.5px;
            background-color: black;
        }

        .underline-title,
        .underline-title-full {
            display: inline-block;
            position: relative;
            font-weight: bold;
        }

        .underline-title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 50%;
            height: 1.5px;
            background-color: black;
        }

        .underline-title-full::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 100%;
            height: 1.5px;
            background-color: black;
        }

        .italic-text {
            font-style: italic;
            text-align: justify;
            margin: 10px 0;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .footer-left {
            width: 60%;
        }

        .footer-right {
            width: 40%;
            text-align: center;
        }

        .signature-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .signature-name {
            font-weight: bold;
            margin-top: 100px;
        }

        .recipient-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 5px;
        }

        .recipient-item {
            margin: 1px 0;
        }

        .control-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .month-selector label {
            font-weight: bold;
            color: #333;
        }

        .month-selector select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .month-selector select:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .control-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .load-button {
            background-color: #2196F3;
            color: white;
        }

        .load-button:hover {
            background-color: #1976D2;
        }

        .print-button {
            background-color: #4CAF50;
            color: white;
        }

        .print-button:hover {
            background-color: #45a049;
        }

        .export-button {
            background-color: #FF9800;
            color: white;
        }

        .export-button:hover {
            background-color: #F57C00;
        }

        .document-content {
            margin-top: 100px;
        }

        @media print {
            .control-panel {
                display: none !important;
            }

            .document-content {
                margin-top: 0;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .page {
                margin: 0;
                padding: 0;
                border: none;
            }

            .page-break {
                display: none !important;
            }

            .landscape-page {
                height: auto !important;
                min-height: 21cm;
                page-break-before: always;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tr {
                page-break-inside: avoid;
            }

            table {
                page-break-inside: auto;
            }
        }

        .text-block {
            text-align: justify;
            text-indent: 30px;
        }

        .table-container {
            width: 100%;
            margin: 20px auto;
            height: auto;
        }

        .table-title {
            text-align: center;
            font-weight: bold;
            font-size: 16pt;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid black;
            page-break-inside: auto;
        }

        th,
        td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            font-size: 12pt;
        }

        th {
            font-weight: bold;
            background-color: #f2f2f2;
        }

        thead {
            display: table-header-group;
        }

        tbody {
            display: table-row-group;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        .text-left {
            text-align: left;
        }

        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Control Panel -->
    <div class="control-panel">
        <div class="month-selector">
            <label for="month-select">Chọn tháng:</label>
            <select id="month-select">
                <option value="1">Tháng 1</option>
                <option value="2">Tháng 2</option>
                <option value="3">Tháng 3</option>
                <option value="4">Tháng 4</option>
                <option value="5">Tháng 5</option>
                <option value="6">Tháng 6</option>
                <option value="7">Tháng 7</option>
                <option value="8">Tháng 8</option>
                <option value="9">Tháng 9</option>
                <option value="10">Tháng 10</option>
                <option value="11">Tháng 11</option>
                <option value="12">Tháng 12</option>
            </select>

            <label for="year-select">Năm:</label>
            <select id="year-select">
                <!-- Years will be populated dynamically -->
            </select>
        </div>

        <div class="action-buttons">
            <button class="control-button load-button" onclick="loadDataForSelectedMonth()">Tải Dữ Liệu</button>
            <button class="control-button print-button" onclick="window.print()">In Tài Liệu</button>
            <button class="control-button export-button" onclick="exportToWordTemplate()">Xuất Word</button>
        </div>
    </div>

    <!-- Loading Message -->
    <div id="loading-message">Đang tải dữ liệu...</div>

    <div class="document-content">
        <!-- First page in portrait orientation -->
        <div class="page">
            <div class="document-container">
                <div class="header">
                    <div class="header-left">
                        <div style="margin-bottom: 5px;">UBND TỈNH BẮC GIANG</div>
                        <div class="underline-title"><strong>SỞ XÂY DỰNG</strong></div>
                        <div class="document-number">Số: <span>______</span>/TB-SXD</div>
                    </div>
                    <div class="header-right">
                        <div style="margin-bottom: 5px;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
                        <div class="underline-title-full"><span class="underline-text">Độc lập – Tự do – Hạnh
                                phúc</span>
                        </div>
                        <div style="font-style: italic; font-weight: normal; margin-top: 10px; text-align: center;"
                            id="ngay-thang">Bắc
                            Giang, ngày &nbsp;&nbsp;&nbsp; tháng &nbsp;&nbsp;&nbsp; <span>năm 2025</span>
                        </div>
                    </div>
                </div>

                <div class="title">
                    THÔNG BÁO<br>
                    <span id="title-thang">Danh sách phương tiện, loại phù hiệu đã cấp, thời hạn có hiệu lực của phù
                        hiệu và
                        đơn vị kinh doanh vận tải đã được cấp giấy phép kinh doanh vận tải bằng xe ô tô; danh sách
                        phương
                        tiện bị thu hồi, bị tước phù hiệu; danh sách đơn vị kinh doanh vận tải bị thu hồi, bị tước giấy
                        phép
                        kinh doanh vận tải bằng xe ô tô trong <span id="thang-thong-bao">tháng</span></span>
                </div>

                <div class="text-block">
                    Căn cứ điểm b khoản 8 Điều 21 Nghị định số 158/2024/NĐ-CP ngày 18/12/2024 của Chính phủ Quy định về
                    hoạt
                    động vận tải đường bộ.
                </div>

                <div class="text-block">
                    Để phục vụ công tác kiểm tra, giám sát của các cơ quan chức năng và chính quyền địa phương trong
                    hoạt
                    động kinh doanh vận tải bằng xe ô tô, Sở Xây dựng tỉnh Bắc Giang thông báo danh sách phương tiện,
                    loại
                    phù hiệu đã cấp, thời hạn có hiệu lực của phù hiệu và đơn vị kinh doanh vận tải đã được cấp giấy
                    phép
                    kinh doanh vận tải bằng xe ô tô; danh sách phương tiện bị thu hồi, bị tước phù hiệu; danh sách đơn
                    vị
                    kinh doanh vận tải bị thu hồi, bị tước giấy phép kinh doanh vận tải bằng xe ô tô trong <span
                        id="thang-thong-bao-2">tháng</span>, cụ
                    thể như sau:
                </div>

                <div class="text-block">
                    <strong>1.</strong> Danh sách các phương tiện được cấp phù hiệu vận tải: Phụ lục I kèm theo;
                </div>
                <div class="text-block">
                    <strong>2.</strong> Danh sách các đơn vị được cấp Giấy phép kinh doanh vận tải bằng xe ô tô: Phụ lục
                    II
                    kèm theo;
                </div>
                <div class="text-block">
                    <strong>3.</strong> Danh sách phương tiện bị thu hồi, bị tước phù hiệu: Phụ lục III kèm theo;
                </div>
                <div class="text-block">
                    <strong>4.</strong> Danh sách đơn vị kinh doanh vận tải bị thu hồi, bị tước giấy phép kinh doanh vận
                    tải: Phụ lục IV kèm theo.
                </div>

                <div class="text-block">
                    Sở Xây dựng tỉnh Bắc Giang trân trọng thông báo./.
                </div>

                <div class="footer">
                    <div class="footer-left">
                        <div><strong>Nơi nhận:</strong></div>
                        <div class="recipient-item">- Công an tỉnh;</div>
                        <div class="recipient-item">- UBND các huyện, thị xã, TP;</div>
                        <div class="recipient-item">- UBND các xã, phường, thị trấn &nbsp; (p/h)</div>
                        <div class="recipient-item">nơi đơn vị vận tải đặt trụ sở; </div>
                        <div class="recipient-item">- Giám đốc Sở (b/c);</div>
                        <div class="recipient-item">- Các đơn vị vận tải;</div>
                        <div class="recipient-item">- Các bến xe khách;</div>
                        <div class="recipient-item">- Văn phòng Sở (đăng Websites);</div>
                        <div class="recipient-item">- Thanh tra Sở;</div>
                        <div class="recipient-item">- Lưu: VT, VTATGT.</div>
                    </div>
                    <div class="footer-right">
                        <div class="signature-title">KT. GIÁM ĐỐC</div>
                        <div class="signature-title">PHÓ GIÁM ĐỐC</div>
                        <div style="margin-top: 195px;"></div>
                        <div class="signature-name">Hoàng Văn Hải</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second page - Phụ lục I -->
        <div class="page landscape-page">
            <div class="landscape-container">
                <div class="table-container">
                    <div class="table-title">
                        PHỤ LỤC I<br>
                        <span id="table-title-thang-1">DANH SÁCH CÁC PHƯƠNG TIỆN ĐƯỢC CẤP PHÙ HIỆU VẬN TẢI TRONG
                            THÁNG</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 4%;">STT</th>
                                <th style="width: 8%;">Biển kiểm soát</th>
                                <th style="width: 7%;">Số ghế</th>
                                <th style="width: 7%;">Tải trọng</th>
                                <th style="width: 10%;">Số phù hiệu</th>
                                <th style="width: 9%;">Loại phù hiệu</th>
                                <th style="width: 9%;">Có giá trị đến</th>
                                <th style="width: 14%;">Tuyến khai thác</th>
                                <th style="width: 15%;">Đơn vị được cấp phù hiệu</th>
                                <th style="width: 17%;">Địa chỉ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-1">
                            <!-- Table rows will be dynamically populated from PHUHIEUXE -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Third page - Phụ lục II -->
        <div class="page landscape-page">
            <div class="landscape-container">
                <div class="table-container">
                    <div class="table-title">
                        PHỤ LỤC II<br>
                        <span id="table-title-thang-2">DANH SÁCH CÁC ĐƠN VỊ ĐƯỢC CẤP GIẤY PHÉP KINH DOANH VẬN TẢI BẰNG
                            XE Ô
                            TÔ TRONG THÁNG</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 4%;">STT</th>
                                <th style="width: 20%;">Tên đơn vị</th>
                                <th style="width: 24%;">Địa chỉ</th>
                                <th style="width: 10%;">Số ĐKKD</th>
                                <th style="width: 14%;">Số GP</th>
                                <th style="width: 10%;">Ngày cấp</th>
                                <th style="width: 18%;">Loại hình được cấp</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-2">
                            <!-- Table rows will be dynamically populated from GIAYPHEPKINHDOANHNOIDIA -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Fourth page - Phụ lục III -->
        <div class="page landscape-page">
            <div class="landscape-container">
                <div class="table-container">
                    <div class="table-title">
                        PHỤ LỤC III<br>
                        <span id="table-title-thang-3">DANH SÁCH CÁC PHƯƠNG TIỆN BỊ THU HỒI PHÙ HIỆU VẬN TẢI TRONG
                            THÁNG</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 4%;">STT</th>
                                <th style="width: 10%;">Biển số</th>
                                <th style="width: 10%;">Số Phù hiệu</th>
                                <th style="width: 10%;">Loại PH</th>
                                <th style="width: 10%;">Hạn Phù hiệu</th>
                                <th style="width: 18%;">Tên đơn vị</th>
                                <th style="width: 22%;">Địa chỉ</th>
                                <th style="width: 16%;">Văn bản ngừng</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-3">
                            <!-- Table rows will be dynamically populated from PHUHIEU_THUHOI_CHITIET -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Fifth page - Phụ lục IV -->
        <div class="page landscape-page">
            <div class="landscape-container">
                <div class="table-container">
                    <div class="table-title">
                        PHỤ LỤC IV<br>
                        <span id="table-title-thang-4">DANH SÁCH CÁC ĐƠN VỊ BỊ THU HỒI GIẤY PHÉP KINH DOANH VẬN TẢI BẰNG
                            XE
                            Ô TÔ TRONG THÁNG</span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 4%;">STT</th>
                                <th style="width: 15%;">Tên đơn vị</th>
                                <th style="width: 24%;">Địa chỉ</th>
                                <th style="width: 10%;">Số ĐKKD</th>
                                <th style="width: 12%;">Số GP KDVT</th>
                                <th style="width: 10%;">Ngày cấp</th>
                                <th style="width: 18%;">Loại hình KDVT đã được cấp</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-4">
                            <!-- Table rows will be dynamically populated from GPKD_THUHOI_CHITIET -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = 'd22767b5-f711-42f8-bbbd-4cf04b26ef3d';
        const accessKey = 'V2-Qcjpo-7Ybu9-g87XI-TFLes-kJGWn-btYR5-cLMmk-FjrRj';
        const region = 'www';

        // Function to populate year selector
        function populateYearSelector() {
            const yearSelect = document.getElementById('year-select');
            const currentYear = new Date().getFullYear();

            // Add years from 2020 to current year + 2
            for (let year = 2020; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Function to set current month and year as default
        function setDefaultMonthYear() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;

            document.getElementById('month-select').value = currentMonth;
        }

        // Function to get selected month and year
        function getSelectedMonthYear() {
            const month = parseInt(document.getElementById('month-select').value);
            const year = parseInt(document.getElementById('year-select').value);
            return { month, year };
        }

        // Function to load data for selected month - cải thiện xử lý lỗi
        function loadDataForSelectedMonth() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');

            if (!monthSelect || !yearSelect) {
                console.error('Không tìm thấy dropdown tháng/năm');
                return;
            }

            const month = parseInt(monthSelect.value);
            const year = parseInt(yearSelect.value);

            if (isNaN(month) || isNaN(year)) {
                console.error('Tháng hoặc năm không hợp lệ');
                alert('Vui lòng chọn tháng và năm hợp lệ');
                return;
            }

            console.log(`Loading data for ${month}/${year}`);
            fetchData(month, year);
        }

        // Function to format date for filtering (yyyy-mm-dd)
        function formatDateForFilter(month, year) {
            const startDate = `${year}-${month.toString().padStart(2, '0')}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month.toString().padStart(2, '0')}-${lastDay}`;
            return { startDate, endDate };
        }

        // Function to cleanup old dynamically created pages
        function cleanupOldPages() {
            // Remove dynamically created pages
            const dynamicPages = document.querySelectorAll('[id*="-page-"]');
            const dynamicBreaks = document.querySelectorAll('.page-break:not(:first-of-type):not(:nth-of-type(2)):not(:nth-of-type(3)):not(:nth-of-type(4))');

            dynamicPages.forEach(page => {
                const parentPage = page.closest('.landscape-page');
                if (parentPage && parentPage.id && parentPage.id.includes('-page-')) {
                    parentPage.remove();
                }
            });

            // Remove extra page breaks
            const allBreaks = document.querySelectorAll('.page-break');
            if (allBreaks.length > 4) {
                for (let i = 4; i < allBreaks.length; i++) {
                    allBreaks[i].remove();
                }
            }
        }

        // Main function to fetch data - cải thiện xử lý tháng/năm
        async function fetchData(selectedMonth = null, selectedYear = null) {
            try {
                // Show loading message
                document.getElementById('loading-message').classList.remove('hidden');

                // Clean up old pages first
                cleanupOldPages();

                // Get month and year với xử lý an toàn hơn
                let month, year;
                if (selectedMonth !== null && selectedYear !== null &&
                    !isNaN(selectedMonth) && !isNaN(selectedYear)) {
                    month = selectedMonth;
                    year = selectedYear;
                } else {
                    // Lấy từ dropdown nếu có, nếu không thì dùng tháng hiện tại
                    const monthSelect = document.getElementById('month-select');
                    const yearSelect = document.getElementById('year-select');

                    if (monthSelect && yearSelect && monthSelect.value && yearSelect.value) {
                        month = parseInt(monthSelect.value);
                        year = parseInt(yearSelect.value);
                    } else {
                        const today = new Date();
                        month = today.getMonth() + 1;
                        year = today.getFullYear();
                    }
                }

                console.log(`Fetching data for month: ${month}, year: ${year}`);

                // Update page 1 content with selected month
                updatePage1Content(month, year);

                // Fetch data from all tables with date filtering
                const [phuHieuData, gpkdData, phuHieuThuHoiData, gpkdThuHoiData] = await Promise.all([
                    fetchTableDataWithFilter('PHUHIEUXE', 'ID_PhuHieu', 'NgayCap', month, year),
                    fetchTableDataWithFilter('GIAYPHEPKINHDOANHNOIDIA', 'ID_GPKD', 'NgayCap', month, year),
                    fetchTableDataWithFilter('PHUHIEU_THUHOI_CHITIET', 'ID_Row', 'Ngày hết hạn phù hiệu', month, year),
                    fetchTableDataWithFilter('GPKD_THUHOI_CHITIET', 'ID_Row', 'Ngày thu hồi', month, year)
                ]);

                // Log kết quả để debug
                console.log('Data fetched:', {
                    phuHieuData: phuHieuData?.length || 0,
                    gpkdData: gpkdData?.length || 0,
                    phuHieuThuHoiData: phuHieuThuHoiData?.length || 0,
                    gpkdThuHoiData: gpkdThuHoiData?.length || 0
                });

                // Populate all tables with data
                populateTable1Data(phuHieuData || []);
                populateTable2Data(gpkdData || []);
                populateTable3Data(phuHieuThuHoiData || []);
                populateTable4Data(gpkdThuHoiData || []);

                // Hide loading message
                hideLoadingMessage();

            } catch (error) {
                console.error('Lỗi:', error);
                hideLoadingMessage();
                alert('Đã xảy ra lỗi khi lấy dữ liệu: ' + error.message);
            }
        }

        // Function to fetch data from any table with date filtering
        async function fetchTableDataWithFilter(tableName, idField, dateField, month, year) {
            try {
                const { startDate, endDate } = formatDateForFilter(month, year);

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {
                            Selector: `SELECT(${tableName}[${idField}], AND([${dateField}] >= DATE("${startDate}"), [${dateField}] <= DATE("${endDate}")))`
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log(`Dữ liệu từ bảng ${tableName}:`, result);
                return result;
            } catch (error) {
                console.error(`Lỗi khi lấy dữ liệu từ bảng ${tableName}:`, error);
                return [];
            }
        }

        // Function to create multi-page tables
        function createMultiPageTable(data, tableId, titlePrefix, maxRowsPerPage = 25) {
            // Find original elements
            const originalPage = document.querySelector(`#${tableId}`).closest('.landscape-page');
            const originalTableBody = document.getElementById(tableId);
            const originalTable = originalTableBody.closest('table');

            // Clear original table body
            originalTableBody.innerHTML = '';

            if (data.length === 0) {
                const columnCount = originalTable.querySelector('thead tr').children.length;
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="${columnCount}" style="text-align: center; font-style: italic;">Không có dữ liệu</td>`;
                originalTableBody.appendChild(row);
                return;
            }

            // Split data into chunks
            const chunks = [];
            for (let i = 0; i < data.length; i += maxRowsPerPage) {
                chunks.push(data.slice(i, i + maxRowsPerPage));
            }

            // Populate first page
            populateTableChunk(chunks[0], originalTableBody, 0, tableId);

            // Create additional pages if needed
            if (chunks.length > 1) {
                for (let i = 1; i < chunks.length; i++) {
                    createAdditionalPage(originalPage, chunks[i], i, tableId, titlePrefix, maxRowsPerPage);
                }
            }
        }

        // Function to create additional pages
        function createAdditionalPage(originalPage, data, pageIndex, tableId, titlePrefix, maxRowsPerPage) {
            const newPage = originalPage.cloneNode(true);
            newPage.id = `${originalPage.id}-page-${pageIndex + 1}`;

            const newTableBody = newPage.querySelector(`#${tableId}`);
            newTableBody.id = `${tableId}-page-${pageIndex + 1}`;

            const newTitle = newPage.querySelector('.table-title span');
            if (newTitle) {
                newTitle.textContent = newTitle.textContent + ` (Trang ${pageIndex + 1})`;
            }

            newTableBody.innerHTML = '';
            populateTableChunk(data, newTableBody, pageIndex * maxRowsPerPage, tableId);

            // Chỉ thêm trang mới, không thêm page-break
            originalPage.parentNode.insertBefore(newPage, originalPage.nextSibling);
        }

        // Function to populate a chunk of data
        function populateTableChunk(data, tableBody, startIndex, tableId) {
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const actualIndex = startIndex + index + 1;

                // Handle different table types
                switch (tableId) {
                    case 'table-body-1': // Phụ lục I
                        row.innerHTML = `
                           <td>${actualIndex}</td>
                           <td>${item.BienSo || ''}</td>
                           <td>${item['Số ghế'] || ''}</td>
                           <td>${item['Tải trọng'] || ''}</td>
                           <td>${item.SoPhuHieu || ''}</td>
                           <td>${item.LoaiPH || ''}</td>
                           <td>${formatDate(item.NgayHetHan)}</td>
                           <td class="text-left">${item['Tuyến khai thác'] || ''}</td>
                           <td class="text-left">${item.Ten_don_vi || ''}</td>
                           <td class="text-left">${item['Địa chỉ'] || ''}</td>
                       `;
                        break;
                    case 'table-body-2': // Phụ lục II
                        row.innerHTML = `
                           <td>${actualIndex}</td>
                           <td class="text-left">${item.TenDonVi || ''}</td>
                           <td class="text-left">${item.DiaChi || ''}</td>
                           <td>${item.SoDKKD || ''}</td>
                           <td>${item.SoGiayPhep || ''}</td>
                           <td>${formatDate(item.NgayCap)}</td>
                           <td class="text-left">${item.LoaiHinhVanTai || ''}</td>
                       `;
                        break;
                    case 'table-body-3': // Phụ lục III
                        row.innerHTML = `
                           <td>${actualIndex}</td>
                           <td>${item['Biển số'] || ''}</td>
                           <td>${item['Số Phù hiệu'] || ''}</td>
                           <td>${item['Loại Phù hiệu'] || ''}</td>
                           <td>${formatDate(item['Ngày hết hạn phù hiệu'])}</td>
                          <td class="text-left">${item['Tên đơn vị'] || ''}</td>
                          <td class="text-left">${item['Địa chỉ'] || ''}</td>
                          <td class="text-left">${item['Văn bản ngừng'] || ''}</td>
                      `;
                        break;
                    case 'table-body-4': // Phụ lục IV
                        row.innerHTML = `
                          <td>${actualIndex}</td>
                          <td class="text-left">${item['Tên đơn vị'] || ''}</td>
                          <td class="text-left">${item['Địa chỉ'] || ''}</td>
                          <td>${item['Số ĐKKD'] || ''}</td>
                          <td>${item['Số GP KDVT'] || ''}</td>
                          <td>${formatDate(item['Ngày cấp'])}</td>
                          <td>${item['Loại hình vận tải'] || ''}</td>
                      `;
                        break;
                }
                tableBody.appendChild(row);
            });
        }

        // Format dates as dd/mm/yyyy with proper administrative formatting
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = date.getMonth() + 1;
            const formattedMonth = month <= 2 ?
                month.toString().padStart(2, '0') :
                month.toString();
            return `${day}/${formattedMonth}/${date.getFullYear()}`;
        }

        // Function to update page 1 content with proper administrative date formatting
        function updatePage1Content(month, year) {
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const currentMonth = today.getMonth() + 1;
            const formattedCurrentMonth = currentMonth <= 2 ?
                currentMonth.toString().padStart(2, '0') :
                currentMonth.toString();

            const formattedMonth = month <= 2 ?
                month.toString().padStart(2, '0') :
                month.toString();

            // Update date
            document.getElementById('ngay-thang').textContent =
                `Bắc Giang, ngày ${day} tháng ${formattedCurrentMonth} năm ${year}`;

            // Update titles with selected month - đảm bảo month và year được định nghĩa
            const monthYearText = `${formattedMonth}/${year}`;

            // Kiểm tra và cập nhật các phần tử một cách an toàn
            const thangThongBao1 = document.getElementById('thang-thong-bao');
            if (thangThongBao1) {
                thangThongBao1.textContent = `tháng ${monthYearText}`;
            }

            const thangThongBao2 = document.getElementById('thang-thong-bao-2');
            if (thangThongBao2) {
                thangThongBao2.textContent = `tháng ${monthYearText}`;
            }

            const tableTitle1 = document.getElementById('table-title-thang-1');
            if (tableTitle1) {
                tableTitle1.textContent = `DANH SÁCH CÁC PHƯƠNG TIỆN ĐƯỢC CẤP PHÙ HIỆU VẬN TẢI TRONG THÁNG ${monthYearText}`;
            }

            const tableTitle2 = document.getElementById('table-title-thang-2');
            if (tableTitle2) {
                tableTitle2.textContent = `DANH SÁCH CÁC ĐƠN VỊ ĐƯỢC CẤP GIẤY PHÉP KINH DOANH VẬN TẢI BẰNG XE Ô TÔ TRONG THÁNG ${monthYearText}`;
            }

            const tableTitle3 = document.getElementById('table-title-thang-3');
            if (tableTitle3) {
                tableTitle3.textContent = `DANH SÁCH CÁC PHƯƠNG TIỆN BỊ THU HỒI PHÙ HIỆU VẬN TẢI TRONG THÁNG ${monthYearText}`;
            }

            const tableTitle4 = document.getElementById('table-title-thang-4');
            if (tableTitle4) {
                tableTitle4.textContent = `DANH SÁCH CÁC ĐƠN VỊ BỊ THU HỒI GIẤY PHÉP KINH DOANH VẬN TẢI BẰNG XE Ô TÔ TRONG THÁNG ${monthYearText}`;
            }
        }

        // Updated populate functions using multi-page tables
        function populateTable1Data(data) {
            createMultiPageTable(data, 'table-body-1', 'PHỤ LỤC I', 25);
        }

        function populateTable2Data(data) {
            createMultiPageTable(data, 'table-body-2', 'PHỤ LỤC II', 25);
        }

        function populateTable3Data(data) {
            createMultiPageTable(data, 'table-body-3', 'PHỤ LỤC III', 25);
        }

        function populateTable4Data(data) {
            createMultiPageTable(data, 'table-body-4', 'PHỤ LỤC IV', 25);
        }

        // Hide loading message
        function hideLoadingMessage() {
            document.getElementById('loading-message').classList.add('hidden');
        }

        // Function to export to Word - cải thiện xử lý tháng/năm
        async function exportToWordTemplate() {
            try {
                document.getElementById('loading-message').classList.remove('hidden');

                // Get selected month info với xử lý an toàn
                let month, year;
                const monthSelect = document.getElementById('month-select');
                const yearSelect = document.getElementById('year-select');

                if (monthSelect && yearSelect && monthSelect.value && yearSelect.value) {
                    month = parseInt(monthSelect.value);
                    year = parseInt(yearSelect.value);
                } else {
                    const today = new Date();
                    month = today.getMonth() + 1;
                    year = today.getFullYear();
                }

                if (isNaN(month) || isNaN(year)) {
                    throw new Error('Tháng hoặc năm không hợp lệ');
                }

                console.log(`Exporting Word for month: ${month}, year: ${year}`);

                const today = new Date();

                // Fetch data from all tables with filtering for selected month
                const [phuHieuData, gpkdData, phuHieuThuHoiData, gpkdThuHoiData] = await Promise.all([
                    fetchTableDataWithFilter('PHUHIEUXE', 'ID_PhuHieu', 'NgayCap', month, year),
                    fetchTableDataWithFilter('GIAYPHEPKINHDOANHNOIDIA', 'ID_GPKD', 'NgayCap', month, year),
                    fetchTableDataWithFilter('PHUHIEU_THUHOI_CHITIET', 'ID_Row', 'Ngày hết hạn phù hiệu', month, year),
                    fetchTableDataWithFilter('GPKD_THUHOI_CHITIET', 'ID_Row', 'Ngày thu hồi', month, year)
                ]);

                // Prepare data for Word template - Phụ lục I
                const phuLuc1List = (phuHieuData || []).map((item, index) => {
                    return {
                        stt: (index + 1).toString(),
                        bien_so: item.BienSo || '',
                        so_ghe: item['Số ghế'] || '',
                        tai_trong: item['Tải trọng'] || '',
                        so_phu_hieu: item.SoPhuHieu || '',
                        loai_phu_hieu: item.LoaiPH || '',
                        co_gia_tri_den: formatDate(item.NgayHetHan),
                        tuyen_khai_thac: item['Tuyến khai thác'] || '',
                        ten_don_vi: item.Ten_don_vi || '',
                        dia_chi: item['Địa chỉ'] || ''
                    };
                });

                // Prepare data for Word template - Phụ lục II
                const phuLuc2List = (gpkdData || []).map((item, index) => {
                    return {
                        stt: (index + 1).toString(),
                        ten_don_vi: item.TenDonVi || '',
                        dia_chi: item.DiaChi || '',
                        so_dkkd: item.SoDKKD || '',
                        so_gp: item.SoGiayPhep || '',
                        ngay_cap: formatDate(item.NgayCap),
                        loai_hinh: item.LoaiHinhVanTai || ''
                    };
                });

                // Prepare data for Word template - Phụ lục III
                const phuLuc3List = (phuHieuThuHoiData || []).map((item, index) => {
                    return {
                        stt: (index + 1).toString(),
                        bien_so: item['Biển số'] || '',
                        so_phu_hieu: item['Số Phù hiệu'] || '',
                        loai_ph: item['Loại Phù hiệu'] || '',
                        han_phu_hieu: formatDate(item['Ngày hết hạn phù hiệu']),
                        ten_don_vi: item['Tên đơn vị'] || '',
                        dia_chi: item['Địa chỉ'] || '',
                        van_ban_ngung: item['Văn bản ngừng'] || ''
                    };
                });

                // Prepare data for Word template - Phụ lục IV
                const phuLuc4List = (gpkdThuHoiData || []).map((item, index) => {
                    return {
                        stt: (index + 1).toString(),
                        ten_don_vi: item['Tên đơn vị'] || '',
                        dia_chi: item['Địa chỉ'] || '',
                        so_dkkd: item['Số ĐKKD'] || '',
                        so_gp_kdvt: item['Số GP KDVT'] || '',
                        ngay_cap: formatDate(item['Ngày cấp']),
                        loai_hinh_kdvt: item['Loại hình vận tải'] || ''
                    };
                });

                const response = await fetch('https://hoangmv.github.io/templates/thong_bao.docx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }
                const templateContent = await response.arrayBuffer();

                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                // Xử lý ngày tháng theo quy tắc hành chính
                const ngayKy = today.getDate().toString().padStart(2, '0');
                const thangKy = today.getMonth() + 1;
                const formattedThangKy = thangKy <= 2 ?
                    thangKy.toString().padStart(2, '0') :
                    thangKy.toString();

                // Xử lý tháng thông báo theo quy tắc
                const thang_thong_bao = month <= 2 ?
                    month.toString().padStart(2, '0') :
                    month.toString();

                // Set data for template với định dạng ngày tháng mới
                const data = {
                    ngayKy: ngayKy,
                    thangKy: formattedThangKy,
                    nam: today.getFullYear(),
                    thang_thong_bao: thang_thong_bao,
                    nam_thong_bao: year,
                    phu_luc_1_list: phuLuc1List,
                    phu_luc_2_list: phuLuc2List,
                    phu_luc_3_list: phuLuc3List,
                    phu_luc_4_list: phuLuc4List
                };

                console.log('Word template data:', data);

                // Render template
                doc.setData(data);
                doc.render();

                // Generate and download file
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `Thong_bao_van_tai_${thang_thong_bao}_${year}.docx`;
                saveAs(blob, fileName);

                console.log(`Word file exported: ${fileName}`);

            } catch (error) {
                console.error('Lỗi khi xuất file Word:', error);
                if (error.properties && error.properties.errors) {
                    console.log('Template Error details:', error.properties.errors);
                }
                alert('Có lỗi khi xuất file Word: ' + error.message);
            } finally {
                document.getElementById('loading-message').classList.add('hidden');
            }
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Populate year selector
            populateYearSelector();

            // Set default month and year
            setDefaultMonthYear();

            // Load data for current month
            const { month, year } = getSelectedMonthYear();
            fetchData(month, year);
        });

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>
