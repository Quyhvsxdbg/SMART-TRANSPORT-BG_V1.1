<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Báo Phù Hiệu Sắp Hết Hạn</title>
    <!-- Thêm các thư viện cần thiết -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <style>
        @page {
            size: A4;
            margin: 1.5cm 1.5cm 1.5cm 2.5cm;
        }

        @page landscape {
            size: A4 landscape;
            margin: 1cm 1.5cm 1cm 2cm;
        }

        body {
            font-family: 'Times New Roman', serif;
            font-size: 14pt;
            line-height: 1.3;
            margin: 0;
            padding: 0;
        }

        .page {
            box-sizing: border-box;
            padding: 0;
            position: relative;
            width: 21cm;
            height: 29.7cm;
            margin: 0 auto;
            background-color: white;
        }

        .landscape-page {
            width: 31.7cm;
            height: 21cm;
            page: landscape;
        }

        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0;
            align-items: flex-start;
        }

        .header-left {
            text-align: center;
            width: 40%;
        }

        .header-right {
            text-align: center;
            width: 60%;
            font-weight: bold;
        }

        .document-number {
            margin-top: 10px;
        }

        .title {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            position: relative;
            font-weight: bold;
        }

        .title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 30%;
            height: 1.5px;
            background-color: black;
        }

        .underline-title,
        .underline-title-full {
            display: inline-block;
            position: relative;
            font-weight: bold;
        }

        .underline-title::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 50%;
            height: 1.5px;
            background-color: black;
        }

        .underline-title-full::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 100%;
            height: 1.5px;
            background-color: black;
        }

        .italic-text {
            font-style: italic;
            text-align: justify;
            margin: 10px 0;
        }

        .footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .footer-left {
            width: 60%;
        }

        .footer-right {
            width: 40%;
            text-align: center;
        }

        .signature-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .signature-name {
            font-weight: bold;
            margin-top: 100px;
        }

        .recipient-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 5px;
        }

        .recipient-item {
            margin: 1px 0;
        }

        .print-button {
            position: fixed;
            top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            z-index: 1000;
        }

        .print-button:hover {
            background-color: #45a049;
        }

        @media print {
            .print-button {
                display: none;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .page {
                margin: 0;
                padding: 0;
                border: none;
            }

            .page-break {
                page-break-after: always;
            }
        }

        .text-block {
            text-align: justify;
            text-indent: 30px;
        }

        .table-container {
            width: 100%;
            margin: 20px auto;
        }

        .table-title {
            text-align: center;
            font-weight: bold;
            font-size: 16pt;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid black;
        }

        th,
        td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            font-size: 12pt;
        }

        th {
            font-weight: bold;
            background-color: #f2f2f2;
        }

        .text-left {
            text-align: left;
        }

        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 2000;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Print Button -->
    <button class="print-button" onclick="window.print()" style="right: 150px;">In Tài Liệu</button>
    <button class="print-button" onclick="exportToWordTemplate()" style="right: 20px;">Xuất Word</button>

    <!-- Loading Message -->
    <div id="loading-message">Đang tải dữ liệu...</div>

    <!-- First page in portrait orientation -->
    <div class="page">
        <div class="document-container">
            <div class="header">
                <div class="header-left">
                    <div style="margin-bottom: 5px;">UBND TỈNH BẮC GIANG</div>
                    <div class="underline-title"><strong>SỞ XÂY DỰNG</strong></div>
                    <div class="document-number">Số: <span>______</span>/TB-SXD</div>
                </div>
                <div class="header-right">
                    <div style="margin-bottom: 5px;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
                    <div class="underline-title-full"><span class="underline-text">Độc lập – Tự do – Hạnh phúc</span>
                    </div>
                    <div style="font-style: italic; font-weight: normal; margin-top: 10px; text-align: center;"
                        id="ngay-thang">Bắc
                        Giang, ngày &nbsp;&nbsp;&nbsp; tháng &nbsp;&nbsp;&nbsp; <span>năm 2025</span>
                    </div>
                </div>
            </div>

            <div class="title">
                THÔNG BÁO<br>
                <span id="title-thang">Danh sách các phương tiện sẽ hết hạn phù hiệu trong tháng</span>
            </div>

            <div class="text-block">
                Căn cứ điểm d khoản 9 Điều 23 Nghị định số 158/2024/NĐ-CP ngày 18/12/2024 của Chính phủ Quy định về hoạt
                động vận tải đường bộ.
            </div>

            <div class="text-block">
                Sở Xây dựng tỉnh Bắc Giang thông báo danh sách các phương tiện sẽ hết hạn phù hiệu vào <span
                    id="thang-thong-bao">tháng</span> <i>(chi
                    tiết theo phụ lục đính kèm).</i>
            </div>

            <div class="text-block">
                Định kỳ 05 ngày làm việc cuối hằng tháng, Sở Xây dựng tỉnh Bắc Giang thông báo bằng văn bản danh sách
                các xe sẽ hết hạn phù hiệu của tháng tiếp theo và đăng tải thông tin trên Website có địa chỉ
                https://sgtvt.bacgiang.gov.vn/) và trên Trang Zalo Official Account “Sở Xây dựng tỉnh Bắc Giang” (tại
                mục: <strong>Tin tức- Phù hiệu đến hạn</strong>).
            </div>

            <div class="text-block">
                Sở Xây dựng tỉnh Bắc Giang thông báo nội dung trên đến các tổ chức, cá nhân để phối hợp quản lý, kiểm
                tra, giám sát./.
            </div>

            <div class="footer">
                <div class="footer-left">
                    <div><strong>Nơi nhận:</strong></div>
                    <div class="recipient-item">- Sở Xây dựng các tỉnh TP;</div>
                    <div class="recipient-item">- Công an tỉnh;</div>
                    <div class="recipient-item">- UBND các huyện, TX, TP và &nbsp; (p/h)</div>
                    <div class="recipient-item"> các xã, phường, thị trấn nơi </div>
                    <div class="recipient-item"> đơn vị vận tải đặt trụ sở; </div>
                    <div class="recipient-item">- Giám đốc Sở (b/c);</div>
                    <div class="recipient-item">- Các đơn vị vận tải;</div>
                    <div class="recipient-item">- Thanh tra Sở;</div>
                    <div class="recipient-item">- Lưu: VT, VTATGT.</div>
                </div>
                <div class="footer-right">
                    <div class="signature-title">KT. GIÁM ĐỐC</div>
                    <div class="signature-title">PHÓ GIÁM ĐỐC</div>
                    <div style="margin-top: 195px;"></div>
                    <div class="signature-name">Hoàng Văn Hải</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page break between pages -->
    <div class="page-break"></div>

    <!-- Second page in landscape orientation -->
    <div class="page landscape-page">
        <div class="landscape-container">
            <div class="table-container">
                <div class="table-title">
                    <span id="table-title-thang">DANH SÁCH CÁC PHƯƠNG TIỆN SẼ HẾT HẠN PHÙ HIỆU VẬN TẢI TRONG
                        THÁNG</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 5%;">STT</th>
                            <th style="width: 10%;">Biển số</th>
                            <th style="width: 10%;">Số Phù hiệu</th>
                            <th style="width: 10%;">Loại PH</th>
                            <th style="width: 10%;">Ngày cấp</th>
                            <th style="width: 10%;">Hạn Phù hiệu</th>
                            <th style="width: 22%;">Tên đơn vị</th>
                            <th style="width: 23%;">Địa chỉ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Table rows will be dynamically populated from PH_SAP_HET_HAN -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Constants for AppSheet connection
        const appId = 'd22767b5-f711-42f8-bbbd-4cf04b26ef3d';
        const accessKey = 'V2-Qcjpo-7Ybu9-g87XI-TFLes-kJGWn-btYR5-cLMmk-FjrRj';
        const region = 'www';

        // Function to get next month and year
        function getNextMonth() {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const month = nextMonth.getMonth() + 1; // getMonth() returns 0-11
            const year = nextMonth.getFullYear();
            return { month, year };
        }

        // Main function to fetch data
        async function fetchData() {
            try {
                // Get next month
                const { month, year } = getNextMonth();

                // Update page 1 content with next month
                updatePage1Content(month, year);

                // Fetch data from PH_SAP_HET_HAN table
                const phSapHetHanData = await fetchPhSapHetHanData();

                if (!phSapHetHanData || phSapHetHanData.length === 0) {
                    hideLoadingMessage();
                    alert('Không tìm thấy dữ liệu phù hiệu sắp hết hạn.');
                    return;
                }

                // Populate page 2 with data
                populateTableData(phSapHetHanData);

                // Hide loading message
                hideLoadingMessage();

            } catch (error) {
                console.error('Lỗi:', error);
                hideLoadingMessage();
                alert('Đã xảy ra lỗi khi lấy dữ liệu: ' + error.message);
            }
        }

        // Fetch PH_SAP_HET_HAN data
        async function fetchPhSapHetHanData() {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/PH_SAP_HET_HAN/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {
                            Selector: 'Select(PH_SAP_HET_HAN[ID_PhuHieu], true)'
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu từ bảng PH_SAP_HET_HAN:', error);
                throw error;
            }
        }

        // Update page 1 content with next month
        function updatePage1Content(month, year) {
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const currentMonth = (today.getMonth() + 1).toString().padStart(2, '0');

            // Update date
            document.getElementById('ngay-thang').textContent =
                `Bắc Giang, ngày ${day} tháng ${currentMonth} năm ${year}`;

            // Update title with next month
            document.getElementById('title-thang').textContent =
                `Danh sách các phương tiện sẽ hết hạn phù hiệu trong tháng ${month}/${year}`;

            document.getElementById('thang-thong-bao').textContent =
                `tháng ${month}/${year}`;

            document.getElementById('table-title-thang').textContent =
                `DANH SÁCH CÁC PHƯƠNG TIỆN SẼ HẾT HẠN PHÙ HIỆU VẬN TẢI TRONG THÁNG ${month}/${year}`;
        }

        // Format dates as dd/mm/yyyy
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }


        // Populate table data for page 2
        function populateTableData(data) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.BienSo || ''}</td>
                    <td>${item.SoPhuHieu || ''}</td>
                    <td>${item.LoaiPH || ''}</td>
                    <td>${formatDate(item.NgayCap)}</td>
                    <td>${formatDate(item.NgayHetHan)}</td>
                    <td class="text-left">${item.Ten_don_vi || ''}</td>
                    <td class="text-left">${item['Địa chỉ'] || ''}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Hide loading message
        function hideLoadingMessage() {
            document.getElementById('loading-message').classList.add('hidden');
        }

        // Function to export to Word using template
        async function exportToWordTemplate() {
            try {
                document.getElementById('loading-message').classList.remove('hidden');

                // Get next month info
                const { month, year } = getNextMonth();
                const today = new Date();

                // Fetch data from PH_SAP_HET_HAN
                const phSapHetHanData = await fetchPhSapHetHanData();
                if (!phSapHetHanData || phSapHetHanData.length === 0) {
                    alert('Không tìm thấy dữ liệu phù hiệu sắp hết hạn.');
                    document.getElementById('loading-message').classList.add('hidden');
                    return;
                }

                // Prepare data for Word template
                const donViList = phSapHetHanData.map((item, index) => {

                    return {
                        stt: (index + 1).toString(),
                        bien_so: item.BienSo || '',           // Đổi từ item['Biển số']
                        so_phu_hieu: item.SoPhuHieu || '',    // Đổi từ item['Số phù hiệu']
                        loai_phu_hieu: item.LoaiPH || '',     // Đổi từ item['Loại phù hiệu']
                        ngay_cap: formatDate(item.NgayCap),
                        ngay_het_han: formatDate(item.NgayHetHan),
                        ten_don_vi: item.Ten_don_vi || '',    // Giữ nguyên
                        dia_chi: item['Địa chỉ'] || ''        // Giữ nguyên
                    };
                });

                // Load Word template
                const response = await fetch('https://hoangmv.github.io/templates/thong_bao_phu_hieu_sap_het_han_template.docx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }
                const templateContent = await response.arrayBuffer();

                // Create PizZip and docxtemplater
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                // Set data for template
                const data = {
                    ngayKy: today.getDate().toString().padStart(2, '0'),
                    thangKy: (today.getMonth() + 1).toString().padStart(2, '0'),
                    nam: today.getFullYear(),
                    thang_het_han: month,
                    nam_het_han: year,
                    don_vi_list: donViList
                };

                // Render template
                doc.setData(data);
                doc.render();

                // Generate and download file
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `Thong_bao_phu_hieu_sap_het_han_${month}_${year}.docx`;
                saveAs(blob, fileName);

            } catch (error) {
                console.error('Lỗi khi xuất file Word:', error);
                if (error.properties && error.properties.errors) {
                    console.log('Template Error details:', error.properties.errors);
                }
                alert('Có lỗi khi xuất file Word: ' + error.message);
            } finally {
                document.getElementById('loading-message').classList.add('hidden');
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>

</html>